---
title: "Status of the Ecosystem - Gulf of Maine"
author: "Ecosystem Dynamics and Assessment Branch, Northeast Fisheries Science Center"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: yes
  pdf_document:
    includes:
      in_header: preamble-latex.tex
    keep_tex: yes
    pandoc_args: --latex-engine=xelatex
    toc: yes
---

```{r Directory and Data Set-up, echo = F, message = F}
knitr::opts_chunk$set(echo = FALSE, fig.align='center')
#data.dir  <- '/home/slucey/EcoAP/SOE2017/data'
#image.dir <- '/home/slucey/EcoAP/SOE2017/images'
data.dir  <- '/users/sgaichas/Documents/0_Data/ESR/SOE2017/data'
image.dir <- '/users/sgaichas/Documents/0_Data/ESR/SOE2017/images'
library(data.table); library(Kendall)
load(file.path(data.dir, 'SOE_data.RData'))
```

```{r Generic Plot Function, echo = F}
#Plot figure
# SKG: need to adjust so that stacked plots have same X axis range
soe.plot <- function(data, x.var, y.var, x.label = '', y.label = '', tol = 0.1, 
                     start = 2006, bg.col = background, end.col = recent, 
                     high.col = high, low.col = low, trend.col = main, 
                     end.trend.col = end, grides = T, limits = c(0.10, 0.90), 
                     stacked = NA, x.line = 2.5, y.line = 3.5){
  x <- data[Var == y.var, ]
  x <- x[order(x[, get(x.var)]), ]
  setnames(x, x.var, 'X')
  
  y.max <- max(x[, Value]) + tol * max(x[, Value])
  y.min <- min(x[, Value]) - tol * abs(min(x[, Value]))
  
  #Plot blank plot
  # SKG: this could be a place for if(stacked) to get common x range
  plot(x[, list(X, Var)], ylim = c(y.min, y.max), xlab = '', ylab = '', 
       axes = F, ty = 'n')
  
  #Add background
  u <- par('usr')
  rect(u[1], u[3], u[2], u[4], border = NA, col = bg.col)
  
  #Add end period shading
  rect(start - 0.5, u[3], u[2], u[4], border = NA, col = end.col)
  
  #Add grides
  if(grides == T) grid(col = "white", lty = 1, lwd = 2)
  
  #Add data points/lines
  points(x[, list(X, Value)], pch = 16, cex = 1.5)
  lines( x[, list(X, Value)], lwd = 2)
  
  #Add axis
  if(is.na(stacked)) axis(1, cex.axis = 1.5)
  if(!is.na(stacked)){
    if(stacked!= 'A') axis(3, cex.axis = 1.5, tck = 0.1, labels = F)
  } 
  axis(2, cex.axis = 1.5, las = T)
  box(lwd = 2)
  
  #Identify extreme values
  limit.val <- quantile(x[, Value], limits)
  x[Value < limit.val[1], Low  := T]
  x[Value > limit.val[2], High := T]
  
  #Highlight extreme values
  points(x[Low == T,  list(X, Value)], col = low.col, 
         pch = 1, cex = 2.5, lwd = 3)
  points(x[High == T, list(X, Value)], col = high.col, 
         pch = 1, cex = 2.5, lwd = 3)
  
  #Identify significant trends
  #Whole time series
  mksts <- MannKendall(x[, Value])
  mkstsp <- round(unlist(mksts[2]), 3)
  
  if(mkstsp < 0.05){
    lmod <- lm(x[, Value] ~ x[, X])
    lmod_c <- unlist(lmod[1])
    lmod_i <- lmod_c[1]
    lmod_s <- lmod_c[2]
    lines(x[, X], lmod_s * x[, X] + lmod_i, 
          col = trend.col, lty = 1, lwd = 7)
  }
  
  #Final portion of time series
  mksld <- MannKendall(x[X > (start - 1), Value])
  mksldp <- round(unlist(mksld[2]), 3)
  if(mksldp < 0.05){
    l10_x <- x[X > (start - 1), X]
    l10_y <- x[X > (start - 1), Value]
    lmod <- lm(l10_y ~ l10_x)
    lmod_c <- unlist(lmod[1])
    lmod_i <- lmod_c[1]
    lmod_s <- lmod_c[2]
    lines(l10_x, lmod_s * l10_x + lmod_i, 
          col = end.trend.col, lwd=7)
  }
  
  #Add axis labels
  if(!is.na(stacked)) text(u[1], u[4], labels = stacked, cex = 2, adj = c(-0.5, 1.5))
  if(is.na(stacked)){
    mtext(1, text = x.label, line = x.line, cex = 1.5)
    mtext(2, text = y.label, line = y.line, cex = 1.5)
  }
}

#Add axis labels for stacked plots
soe.stacked.axis <- function(x.label, y.label){
  axis(1, cex.axis = 1.5)
  mtext(1, text = x.label, line = 2.5, cex = 1.5, outer = T)
  mtext(2, text = y.label, line = 3.5, cex = 1.5, outer = T)
}
```

```{r Plot options, echo = F}
#Background colors
background   <- '#F4F7F2'
recent       <- '#E6E6E6'
#High/low point highlights
high <- rgb(1, 0, 0, alpha = 0.3)
low  <- rgb(0, 0, 1, alpha = 0.3)
#trend lines
main <- rgb(1.000, 0.647, 0.00, alpha = 0.3)
end  <- rgb(0.627, 0.125, 0.941, alpha = 0.3)
```

#Overall View of the Ecosystem
##Conceptual model of ecosystem function

```{r Conceptual Diagram, echo = F, out.width = "400pt"}
knitr::include_graphics(file.path(image.dir, 'GOMoverview_graylines.png'))

```


##Composite view of ecosystem state
What is going on out there? Are the signs for higher or lower productivity? Earlier or later seasons? Changes in species mixes or interactions? 

##Living marine resources status
How many species are sustainably fished (or not)
How many protected species are ok (or not)
Anything to watch this year--interactions with the species in poor shape

#Human Dimensions 
##Community engagement  
Coastal communities have varying degress of dependence on fishing. In particular, communities around the Gulf of Maine have higher dependence on commercial fishing than in other regions of the Northeast US shelf.

```{r Community engagement, echo = F, out.width = "400pt"}
knitr::include_graphics(file.path(image.dir, 'CommrercialReliance.pdf'))

```

##Aggregate measures of fishing performance  


##Recreational fishing  


##Mariculture  
Aquaculture products in Maine include Atlatic salmon, blue mussels and oysters.

```{r Mariculture harvest fish, echo = F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'aquaculture ME Atlantic salmon harvest weight', stacked = 'A')
soe.plot(SOE.data, 'Time', 'aquaculture ME trout harvest weight', stacked = 'B')

soe.stacked.axis('Year', expression('Amount sold, whole pounds'))
```
Maine aquaculture harvest: A-Atlantic salmon, B-trout
```{r Mariculture harvest shellfish, echo = F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'aquaculture ME blue mussels harvest weight', stacked = 'A')
soe.plot(SOE.data, 'Time', 'aquaculture ME oysters harvest weight', stacked = 'B')

soe.stacked.axis('Year', expression('Amount sold whole pounds'))
```
Maine aquaculture harvest: A - hard clams, B - oysters

#Resource Species
Patterns for groups of species that feed on similar prey can indicate how overall ecosystem conditions are changing, and provide context for individual species stock assessments. This information is from NEFSC bottom trawl surveys in spring and fall.  
##Species groupings
```{r pars, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Group                   | N species | Major species in the group       |
|:------------------------|:----------|:---------------------------------|
| A: Benthos              | n  | scallops, |
| B: Mesoplanktivores     | n  | I have no idea |
| C: Macroplanktivore     | n  | what we mean here |
| D: Macrozoo-piscivores  | n  | need to spell it out, maybe indicate (season) of dominance for a species|
| E: Benthivores          | n  | flounders, haddock|
| F: Piscivores           | n  | cod, dogfish, |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```


##Trends in biomass
```{r Fall survey trends, echo = F, fig.height = 8}
opar <- par(mfrow = c(6, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'GOM Benthos Fall',            stacked = 'A')
soe.plot(SOE.data, 'Time', 'GOM Mesoplanktivore Fall',    stacked = 'B')
soe.plot(SOE.data, 'Time', 'GOM Macroplanktivore Fall',   stacked = 'C')
soe.plot(SOE.data, 'Time', 'GOM Macrozoo-piscivore Fall', stacked = 'D')
soe.plot(SOE.data, 'Time', 'GOM Benthivore Fall',         stacked = 'E')
soe.plot(SOE.data, 'Time', 'GOM Piscivore Fall',          stacked = 'F')

soe.stacked.axis('Year', expression('Survey biomass, kg tow'^-1))
```
Fall survey biomass trends. A - Benthos, B - Mesoplanktivores, C - Macroplanktivores,
D - Macrozoo-piscivores, E - Benthivores, F - Piscivores

```{r Spring survey trends, echo = F, fig.height = 8}
opar <- par(mfrow = c(6, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'GOM Benthos Spring',            stacked = 'A')
soe.plot(SOE.data, 'Time', 'GOM Mesoplanktivore Spring',    stacked = 'B')
soe.plot(SOE.data, 'Time', 'GOM Macroplanktivore Spring',   stacked = 'C')
soe.plot(SOE.data, 'Time', 'GOM Macrozoo-piscivore Spring', stacked = 'D')
soe.plot(SOE.data, 'Time', 'GOM Benthivore Spring',         stacked = 'E')
soe.plot(SOE.data, 'Time', 'GOM Piscivore Spring',          stacked = 'F')

soe.stacked.axis('Year', expression('Survey biomass, kg tow'^-1))
```
Spring survey biomass trends. A - Benthos, B - Mesoplanktivores, C - Macroplanktivores,
D - Macrozoo-piscivores, E - Benthivores, F - Piscivores

<!--##Forage Fish
Removing this section until we have a better index-->

##Species composition
What do these mean?
```{r Fall Species composition, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'FALL GOM ESn', x.label = 'Year', 
         y.label = 'Expected n species per 100 fish')

```
Fall

```{r Spring Species composition, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'SPRING GOM ESn', x.label = 'Year', 
         y.label = 'Expected n species per 100 fish')

```
Spring

##Species distribution  
Spatial distribution has changed over time for some species more than for others. Lobster distributions measured by NEFSC surveys have shifted northward relative to historical distributions. However, redfish distributions in the Gulf of Maine have remained relatively stable. A full suite of these maps are available at 

##Species condition   
Fish condition is measured as the weight per length--a measure of "fatness". This information is from NEFSC bottom trawl surveys and shows a change in condition across all species at around 2000. Around 2010-2013 many species started to have better condition, while yellowtail flounder remain thin for their length on average.
```{r Fish Condition, echo = F}
#I will get the actual code here eventually but just don't have time right now
knitr::include_graphics(file.path(image.dir, 'Fish_Condition.jpg'))

```

##Groundfish productivity  
The amount of small fish relative to larger fish of the same species from the NEFSC surey is a simple measure of productivity, intended to complement model-based stock assessments for commercial species. 

#Species of concern
##Marine mammals
North Atlantic right whales are among the most endangered large whale populations in the world. Although the population increased steadily from 1990 to 2011, it has decreased recently. 

```{r Marine Mammals, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'Right whale population', x.label = 'Year',
         y.label = 'Minimum n alive')
```

<!--##Turtles-->
##Fish
Despite diverse population structures and management regimes, concurrent abundance declines in disparate North American and European Atlantic salmon populations suggest that conditions experienced at common marine areas may be causative. In the early 1990’s, bottom-up ecosystem processes changed as a result of a region-wide regime-shift in the Northwest Atlantic. Large scale climate forcing mechanisms altered thermal, salinity, and oceanographic regimes, which altered the flow of energy through the ecosystem. Diet analysis of Atlantic salmon sampled off the coast of West Greenland demonstrated that they are consuming slightly less capelin by weight, but more lower quality prey (amphipods and squid) in contemporary times compared to the late 1960’s/early 1970’s. Further, the energy density of capelin, their primary prey item at Greenland (~40-90% annually), decreased by almost 34% after the regime shift (Figure 1). This coincides with an approximate 66% reduction in Atlantic salmon marine productivity and suggests that Atlantic salmon at Greenland may not be able to satisfy energy demands due to changes in regional trophic dynamics. The inability of these pre-spawners to meet energetic requirements may negatively affect survival over the winter, maturation, migration, and ultimately population abundance. The influence of declining resource quality is not unique to Atlantic salmon, as some populations of Atlantic cod, Bluefin tuna, seabirds, marine mammals and even polar bears are either of lower body condition and/or not as productive as they once were in the region pre-1990.  This may partially be a response to reduced prey quality caused by changes in bottom-up processes. Determining and understanding the mechanisms that influence marine food-webs is necessary to fully evaluate survival and productivity trends, and to establish realistic management targets for commercial, recreational, and protected species.


##Seabirds


#Lower Trophic Levels
##Phytoplankton production

##Hazardous algal blooms

##Zooplankton

```{r Calanus anomoly, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'GOM Yearly Calanus Anomaly', x.label = 'Year',
         y.label = 'Calanus biomass anomaly')
```
```{r biovolume, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'GOM Yearly Zooplankton Biovolume', x.label = 'Year',
         y.label = 'Zooplankton biovolume anomaly')
```
```{r small copeopods, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'GOM Yearly small copeopods anomaly', x.label = 'Year',
         y.label = 'Small copeopod biomass anomaly')
```

#Physical Environment
##Annual sea surface temperature cycle
##Long-term sea surface temperature
##Bottom temperature
```{r Bottom temperature, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'Bottom temp GOM', x.label = 'Year',
         y.label = expression('Bottom temperature, '*degree*'C'))
```


##Stratification
```{r Stratification, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'Stratification (0-50m) GOM core', x.label = 'Year',
         y.label = 'Stratification', y.line = 4.5)
```

##Thermal habitat
##Sea surface temperature forecast
##Precipitation
##Salinity
```{r Salinity, echo = F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'Surface salinity GOM', stacked = 'A', tol = 0.01)
soe.plot(SOE.data, 'Time', 'Bottom salinity GOM',  stacked = 'B', tol = 0.01)

soe.stacked.axis('Year', 'Salinity, PSU')
```
A - Surface, B - Bottom

##Species habitat

#Climate Indices
##Gulf Stream North Wall
```{r Gulf Stream, echo = F}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data, 'Time', 'Gulf Stream Index', x.label = 'Year',
         y.label = expression('Gulf Stream North Wall, '*degree*'latitude'),
         tol = 0.01)
```

##Local scale indicators
##Inundation
##Sea surface temperature phenology
##Ocean acidification
##Community level climate indicators


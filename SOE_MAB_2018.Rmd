---
title: "State of the Ecosystem - Mid-Atlantic Bight"
author: "Ecosystem Dynamics and Assessment Branch, Northeast Fisheries Science Center"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: pdf_document
geometry: margin=1cm
always_allow_html: yes
---

```{r Directory and Data Set-up, echo=F, message=F, warning=FALSE, paged.print=TRUE}
#data.dir  <- '/home/slucey/EcoAP/SOE2017/data'
#image.dir <- '/home/slucey/EcoAP/SOE2017/images'
#data.dir <- 'Z:\\SOE2017\\data'
#image.dir <- 'Z:\\SOE2017\\images'
data.dir  <- "F:/SOE/SOE_data"
image.dir <- "F:/SOE/SOE_data"
#data.dir  <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018'
#image.dir <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018/images'
library(data.table); library(Kendall)
load(file.path(data.dir, "SOE_data_2018.Rdata"))
knitr::opts_chunk$set(echo = FALSE)
```


```{r libraries and functions, include=F, echo = F}

#load("SOE_data_2018.Rdata")
PKG <-c("Kendall","data.table","zoo","dplyr","nlme","AICcmodavg",
        "Hmisc", "leaflet", "rgdal", "colorRamps")

for (p in PKG) {
  if(!require(p,character.only = TRUE)) {
    install.packages(p)
    library(p)  }
}


fit_lm <- function(dat) {
  # Remove missing values first so that all models
  # use the same number of observations (important for AIC)
  # dat <- dat %>% dplyr::filter(complete.cases(.))
  
  # Constant model (null model used to calculate 
  # overall p-value)
  constant_norm <-
    nlme::gls(series ~ 1, 
              data = dat)
  
  constant_ar1 <-
    try(nlme::gls(series ~ 1,
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(constant_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA)) 
  } 
  
  
  
  # Linear model with normal error
  linear_norm <- 
    nlme::gls(series ~ time, 
              data = dat)
  
  # Linear model with AR1 error
  linear_ar1 <- 
    try(nlme::gls(series ~ time, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(linear_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Polynomial model with normal error
  dat$time2 <- dat$time^2
  poly_norm <- 
    nlme::gls(series ~ time + time2, 
              data = dat)
  
  # Polynomial model with AR1 error
  poly_ar1 <- 
    try(nlme::gls(series ~ time + time2, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(poly_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Calculate AICs for all models
  df_aicc <-
    data.frame(model = c("poly_norm",
                         "poly_ar1",
                         "linear_norm",
                         "linear_ar1"),
               aicc  = c(AICc(poly_norm),
                         AICc(poly_ar1),
                         AICc(linear_norm),
                         AICc(linear_ar1)),
               coefs = rbind(coef(poly_norm),
                             coef(poly_ar1),
                             c(coef(linear_norm), NA),
                             c(coef(linear_ar1),  NA)),
               # Calculate overall signifiance (need to use
               # ML not REML for this)
               pval = c(anova(update(constant_norm, method = "ML"),
                              update(poly_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(poly_ar1, method = "ML"))$`p-value`[2],
                        anova(update(constant_norm, method = "ML"),
                              update(linear_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(linear_ar1, method = "ML"))$`p-value`[2]))
  
  best_lm <-
    df_aicc %>%
    dplyr::filter(aicc == min(aicc))
  
  
  if (best_lm$model == "poly_norm") {
    model <- poly_norm
  } else if (best_lm$model == "poly_ar1") {
    model <- poly_ar1
  } else if (best_lm$model == "linear_norm") {
    model <- linear_norm
  } else if (best_lm$model == "linear_ar1") {
    model <- linear_ar1
  }
  
  return(list(p = best_lm$pval,
              model = model))
}


#Plot new figure - Set end.start to 10 years before end of time series

soe.plot <- function(data, x.var, y.var, x.label = '', y.label = '', tol = 0.1,
                     x.start = NA, x.end = NA, end.start = 2008, bg.col = background, mean_line = T,
                     end.col = recent, stacked = NA, x.line = 2.5, y.line = 3.5, scale.axis = 1,
                     rel.y.num = 1.5, rel.y.text = 1.5, suppressAxis = FALSE,status  = F,
                     endshade = TRUE, full.trend = TRUE, point.cex = 1.5, lwd = 2, ymax = TRUE,ymin = TRUE,
                     y.upper = y.upper, y.lower = y.lower, extra = FALSE, x.var2 = x.var2, y.var2 = y.var2,
                     line.forward = FALSE) {
  
  #print("You'll need to remove or interpolate NA values before this function will work")
  
  #Select Data
  x <- data[Var == y.var, ]
  x <- x[order(x[, get(x.var)]), ]
  setnames(x, x.var, 'X')
  
  #Set common time step if necessary
  if(is.na(x.start)) x.start <- min(x[, X])
  if(is.na(x.end))   x.end   <- max(x[, X])
  x <- x[X >= x.start, ]
  
  #Set up plot parameters
  if (ymax == TRUE){
    y.max <- max(x[, Value]) + tol * max(x[, Value])
  } else {
    y.max <- as.numeric(y.upper)
  }
  
  if (ymin == TRUE){
    y.min <- min(x[, Value]) - tol * abs(min(x[, Value]))
  } else if (ymin == FALSE){
    y.min <- as.numeric(y.lower)
  }
  
  y.mean <- mean(x[, Value])
  y.sd <- sd(x[, Value])
  
  #Plot blank plot
  plot(x[X >= x.start, list(X, Var)], xlim = c(x.start, x.end),
       ylim = c(y.min,y.max), xlab = '', ylab = '', axes = F, ty = 'n')
    #Add grides

  #Add background
  u <- par('usr')
  rect(u[1], u[3], u[2], u[4], border = NA, col = bg.col)

  #Add end period shading
  if (endshade == TRUE){
    rect(end.start - 0.5, u[3], u[2], u[4], border = NA, col = end.col)
    abline(h = u[3], lwd=3)
    abline(v = u[1], lwd=3)
  } else {
    abline(h = u[3], lwd=3)
    abline(v = u[1], lwd=3)
  }
  
  if (mean_line == TRUE){
    abline(h = y.mean, col = 'grey', lwd = 3, lty = 2)
  }
  
  #Add data points/lines
  points(x[, list(X, Value)], pch = 16, cex = point.cex)
  lines( x[, list(X, Value)], lwd = lwd)
  
  #extra lines
  if (extra == TRUE){
    x2 <- data[Var == y.var2, ]
    x2 <- x2[order(x2[, get(x.var2)]), ]
    setnames(x2, x.var2, 'X2')
    x2 <- x2[X2 >= x.start, ]
    abline(h = mean(x2[, Value]), col = 'lightcoral', lwd = 3, lty = 2)
    points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
    lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
    }
    
  
  #Add axis
  if (suppressAxis == FALSE){
    if(is.na(stacked)) axis(1, cex.axis = 1.5)
    if(!is.na(stacked)){
      if(stacked!= 'A') axis(3, cex.axis = 1.5, tck = 0.1, labels = F)
    }
  }

  #Stacked axes with 0 overlap so need to remove
  labels <- axTicks(2) / scale.axis
  if(labels[1] == 0) labels[1] <- ''
  axis(2, at = axTicks(2), labels = labels, cex.axis = rel.y.num,
       las = T)
  
  #Final portion of time series
  if (status == T){
    l10_x <- x[X > (end.start - 1), X]
    l10_y <- x[X > (end.start - 1), Value]
    lmod <- lm(l10_y ~ l10_x)
    lmod_c <- unlist(lmod[1])
    lmod_i <- lmod_c[1]
    lmod_s <- lmod_c[2]
    if(lmod_s > 0){
      lines(l10_x, lmod_s * l10_x + lmod_i,
            col = main.pos, lwd=5)
    }
    if(lmod_s < 0){
      lines(l10_x, lmod_s * l10_x + lmod_i,
            col = main.neg, lwd=5)
    }
  }

    #Add axis labels
    if(!is.na(stacked)) text(u[1], u[4], labels = stacked, cex = 2, adj = c(-0.5, 1.5))
    if(is.na(stacked)){
      mtext(1, text = x.label, line = x.line, cex = 1.5)
      mtext(2, text = y.label, line = y.line, cex = rel.y.text)
    }
  
  if (full.trend == T){
    #Split data into past decade and full time series
    dat <- as.data.frame(x[, list(X, Value)])
    
    dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
    # Fit linear model
    lm_out <- fit_lm(dat = dat)
    p <- lm_out$p
    if (p < .05){
        
      newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
      newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
      lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

      year <- seq(x$X[1],x$X[length(x$X)],length.out = length(dat$time))
      # Make plot
      if (lm_pred$fit[length(lm_pred$fit)] > (lm_pred$fit[1] + lm_pred$fit[1]*.1)){
        lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
      } else if (lm_pred$fit[length(lm_pred$fit)] < (lm_pred$fit[1] - lm_pred$fit[1]*.1)){
        lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        }
      } else {
        lines(year, lm_pred$fit, col = "#ffffbf", lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex, col = "indianred")
        lines( x[, list(X, Value)], lwd = lwd, col = "indianred")
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
        }
    }
    
    if (extra == TRUE){
      
      # Second variable
      dat <- as.data.frame(x2[, list(X2, Value)])
    
      dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
     # Fit linear model
      lm_out <- fit_lm(dat = dat)
      p <- lm_out$p
      points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
      lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
      if (p < .05){
    
        newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
        newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
        lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

        year <- seq(x2$X2[1],x2$X2[length(x2$X2)],length.out =length(dat$time))
    # Make plot
        if (lm_pred$fit[length(lm_pred$fit)] > (lm_pred$fit[1] + lm_pred$fit[1]*.1)){
          lines(year, lm_pred$fit, col = main.pos, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else if (lm_pred$fit[length(lm_pred$fit)] < (lm_pred$fit[1] - lm_pred$fit[1]*.1)){
          lines(year, lm_pred$fit, col = main.neg, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else {
          lines(year, lm_pred$fit, col = "#ffffbf", lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        }
     }
    }

  }
 
}  


#Add axis labels for stacked plots
soe.stacked.axis <- function(x.label, y.label, x.line = 2.5,rel.x.text = 1.5,
                             y.line = 3.5, rel.y.text = 1.5, outer = TRUE){
  axis(1, cex.axis = rel.x.text)
  mtext(1, text = x.label, line = x.line, cex = 1.5, outer = outer)
  mtext(2, text = y.label, line = y.line, cex = rel.y.text, outer = outer)
  
}


#Background colors
background   <- 'white'
recent       <- '#E6E6E6'
main.pos <- rgb(253/255, 184/255, 99/255,  alpha = .9)
main.neg <- rgb(178/255, 171/255, 210/255, alpha = .9)

#Finder function for quickly finding variables based on partial match
finder <- function(data, match = match, factor = T){
  found <- unique(data[grepl(match,data$Var),]$Var)
  if (factor == T){
    return(found)
  } else {
    return(as.character(found))
  }
  
}


```

# Conceptual model

```{r, fig.cap="Mid-Atlantic Ecosystem \\label{conceptual}", fig.height=6, fig.width=4, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
knitr::include_graphics(file.path(image.dir, 'MAB_5.png'))

```

\clearpage

# Objectives

\begin{table}[ht]
 \caption{Mid-Atlantic ecosystem objectives}
\centering
\begin{tabular}{lll}
  \hline
 & Objective Categories & Indicators reported here \\ 
  \hline
 & Seafood production & Landings by feeding guild, mariculture \\ 
   & Profits & Revenue by feeding guild \\ 
   & Recreation & Number of anglers and trips \\ 
   & Stability & Diversity indices (fishery and species) \\ 
   & Social-Cultural & Community vulnerability, fishery engagement and reliance \\ 
   & Biomass & Biomass or abundance by feeding guild from surveys \\ 
   & Productivity & Condition and recruitment of MAFMC managed species \\ 
   & Trophic structure & Relative biomass of feeding guilds, primary productivity \\ 
   & Habitat & Thermal habitat projections, estimated habitat occurrence \\ 
   \hline
\end{tabular}
\end{table}

# Species Groupings 

\begin{table}[ht]
 \caption{Mid-Atlantic Bight Feeding Guilds}
\centering
\newcommand{\splat}{\vrule width 0 pt height 15pt depth 5pt\relax}
\begin{tabular}{lp{2.75in}cp{2.5in}}
  \hline
 & Feeding group & N species & Major species in group \\ 
  \hline
\splat & \textbf{A: Apex Predator} (Highest trophic level) & 4 & shark (Unc.), swordfish, yellowfin and bluefin tuna \\   
  
\splat & \textbf{B: Piscivore} (Eat fish) & 23 & spiny dogfish, summer flounder, bluefish, striped bass, weakfish, monkfish, winter and thorny skates, silver and offshore hake, Atlantic cod and halibut, fourspot flounder \\   

\splat & \textbf{C: Benthivore} (Eat bottom dwellers) & 25 & black sea bass, scup, tilefish, tautog, cunner, blue crab, red crab, lobster, ocean pout, haddock, yellowtail, winter, and witch flounders, barndoor skate, American plaice, other crabs \\ 

\splat & \textbf{D: Planktivore} (Eat plankton) & 16 & Atlantic and blueback herring, alewife, shad, menhaden, cusk, Atlantic mackerel, butterfish, blackbelly rosefish, sculpins, lumpfish, northern searobin, northern sand lance, northern shortfin and longfin squid \\ 

\splat & \textbf{E: Benthos} (Bottom dwellers) & 9 & scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars and urchins \\ 
   \hline
\end{tabular}
\end{table}

\clearpage

# Executive Summary

```{r, fig.cap="Summary of single species status for MAFMC stocks \\label{KOBE}", fig.height=7, fig.width=7, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
#knitr::include_graphics(file.path(image.dir, 'MAFMC_joint_stocks_2017.pdf'))

dat <- read.csv("2017assess.csv")

stocks <- unique(dat$Entity.Name)
n.stocks <- length(stocks)

decoder <- read.csv(file.path(data.dir,"2017decoder.csv"))
# set up the headers for most.recent structure - will contain oldest Assessment.Year
most.recent <- dat[1,]
most.recent <- most.recent[-1,]

for (i in 1:n.stocks){
  temp <- dat[dat$Entity.Name == decoder$Entity.Name[i],]
  most.recent <- rbind(most.recent,temp[temp$Assessment.Year == max(temp$Assessment.Year),])
}
#cbind(n.stocks,length(most.recent[,1]))

# get the max of F.Flimit and F.Fmsy and the max of B.Blimit and B.Bmsy
Frat <- most.recent$F.Fmsy
Brat <- most.recent$B.Bmsy
#Frat[6] <- most.recent$F.Flimit[6]  # Ocean Quahog use Flimit because no Fmsy
#Frat[18] <- 0.88  # hardwire average of the two GOM models for GOM cod
#Brat[18] <- 0.155 # hardwire average of the two GOM models for GOM cod
#model averages have been calculated and included in F/Fmsy column in 2017assess.csv
#cbind(most.recent$Entity.Name,most.recent$F.Flimit,most.recent$F.Fmsy)

# figure out appropriate range for axes WARNING HARD CODED
#max(Frat,na.rm=T)
#max(Brat,na.rm=T)
x.r <- c(0,3)
y.r <- c(0,3)

# set some colors
my.col <- rep(NA,n.stocks)
MA.col <- "blue"
NE.col <- "blue"
BO.col <- "purple"
for (i in 1:n.stocks){
  if(decoder$Council[i] == "MAFMC") my.col[i] <- MA.col
  if(decoder$Council[i] == "NEFMC") my.col[i] <- NE.col
  if(decoder$Council[i] == "Both")  my.col[i] <- BO.col
}

# create new matrix for plotting
xx <- as.data.frame(cbind(decoder[,2:8],Frat,Brat,my.col))
newlist <- as.factor(decoder$Code)
others <- as.factor("7 Skates")
sppcodes <- unlist(list(newlist, others))
MA.unknown <- sppcodes[c(1,3,4,47,48)] #mackerel, Loligo, Illex, monkfish unknown
#MA.unknown <- decoder$Code[c(1,3,4,8)] #BSB known
#NE.unknown <- c(decoder$Code[c(14,23,33)],"7 Skates")
NE.overfished <- sppcodes[c(17,19)] # GB cod, halibut
NE.unknown <- sppcodes[c(14,23,33,35,37,47,48,50)] #Red deepsea crab,  Offshore hake, GOM winter flounder, Witch flounder, GB YT,2 monkfish, 7 skates unknown


# break out the Councils
MA <- xx[xx$Council == "MAFMC",]
NE <- xx[xx$Council == "NEFMC",]
BO <- xx[xx$Council == "Both",]
MABO<-rbind(MA, BO)
NEBO<-rbind(NE, BO)

#if(saveplots) png(file = "MAFMC_joint_stocks_2017.png",  units="in", width = 6, height = 6, res=1200)
plot(MABO$Brat,MABO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[c(1:11,47:49)])
  abline(v=0.5,lty=2)
  abline(v=1,lty=3)
  abline(h=1,lty=2)
  title(expression("MAFMC " * phantom("and Joint Stocks")), col.main="blue")
  title(expression(phantom("MAFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
  title(expression(phantom("MAFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
  title(expression(phantom("MAFMC and Joint") * " Stocks"), col.main="black")  
  legend('topright',legend=MA.unknown,pch=NA,text.col=my.col[c(1,3,4,47,48)], title="Unknown Status", title.col = "black")
  text(MABO$Brat,MABO$Frat,labels=MABO$Code,pos=MABO$my.pos3,col=my.col[c(1:11,47:49)],cex=0.8)
#if(saveplots) savePlot("MAFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

#if(saveplots) pdf(file = "NEFMC_joint_stocks.pdf",  width = 6, height = 6)
#if(saveplots) png(file = "NEFMC_joint_stocks.png",  units="in", width = 6, height = 9, res=1200)
# plot(NEBO$Brat,NEBO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[12:49])
#    abline(v=0.5,lty=2)
#    abline(v=1,lty=3)
#    abline(h=1,lty=2)
#    title(expression("NEFMC " * phantom("and Joint Stocks")), col.main="blue")
#    title(expression(phantom("NEFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
#    title(expression(phantom("NEFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
#    title(expression(phantom("NEFMC and Joint") * " Stocks"), col.main="black")  
#    legend('topright',legend=NE.overfished,pch=NA,title="Overfished, F \nStatus Unknown",bty="n", text.width=strwidth("Offshore Hake"), inset=c(0,.05))
#    legend('right',legend=NE.unknown,pch=NA,title="Unknown Status", bty="n")
#    text(NEBO$Brat,NEBO$Frat,labels=NEBO$Code,pos=NEBO$my.pos3,col=my.col[12:49],cex=0.8)
#if(saveplots) savePlot("NEFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

```

\begin{table}[ht]
  \caption{Proportion of catch managed by MAFMC (2016)}
\centering
\newcommand{\splat}{\vrule width 0 pt height 15pt depth 2pt\relax}
\begin{tabular}{lp{1.25in}cc} 
\hline 
 & Groups & MAB Landings &  MAB Revenue \\ 
\hline  
\splat & Piscivore & $0.514$ &  $0.739$ \\ 
\splat & Planktivore & $0.639$ & $0.925$ \\ 
\splat & Benthivore & $0.146$ &  $0.122$ \\ 
\splat & Benthos & $0.618$ &  $0.096$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 


# Human Dimensions 

## Seafood production 

## MAFMC seafood specific landings (red) and total commericial landings (black) (A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos)

```{r seafood_landings_MAB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

## Ecosystem-wide and managed species total landings
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time","Apex Predator Landings MAB", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 )

soe.plot(SOE.data.2018, "Time", "Piscivore Landings MAB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Piscivore MAFMC managed species sea food MAB")


soe.plot(SOE.data.2018, "Time", "Planktivore Landings MAB", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Planktivore MAFMC managed species sea food MAB")
soe.plot(SOE.data.2018, "Time", "Benthivore Landings MAB", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Benthivore MAFMC managed species sea food MAB")
soe.plot(SOE.data.2018, "Time", "Benthos Landings MAB", stacked = "E",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Benthos MAFMC managed species sea food MAB")
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)

```
<!--
## Total commercial landings by feeding guild (A: Apex Predator, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos)

```{r landings_MAB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Apex Predator Landings MAB", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         x.start = 1986)
soe.plot(SOE.data.2018, "Time", "Piscivore Landings MAB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         x.start = 1986)
soe.plot(SOE.data.2018, "Time", "Planktivore Landings MAB", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         x.start = 1986)
soe.plot(SOE.data.2018, "Time", "Benthivore Landings MAB", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         x.start = 1986)
soe.plot(SOE.data.2018, "Time", "Benthos Landings MAB", stacked = "E",status =F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         x.start = 1986)
#soe.plot(SOE.data.2018, "Time", "Total Landings MAB", stacked = "F",status  = F,
#         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3)
soe.stacked.axis("Time",expression("Landings 10"^3*" metric tons"), outer = T)

```
-->

## Ecosystem-wide and managed species total landings

```{r managed_landings ,  echo=F, message=FALSE, warning=FALSE , fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
# managed_land <- SOE.data.2018 %>% filter(Var == "Total managed landings MAB",Time >= 1986)
# total_land <-  SOE.data.2018 %>% filter(Var == "Total Landings MAB",Time >= 1986)
# 
# plot(total_land$Time, total_land$Value, col = "black", type = "o",ylab = "",xlab = "Time",
#                        lwd = 3, pch = 16,cex.lab=1.5, las = 1, cex.axis = 1.5,
#      bty = "l",ylim = c(4e4,28e4),yaxt = "n")
# 
# points(managed_land$Time, managed_land$Value, col = "indianred", type = "o",
#                        lwd = 3, pch = 16)
# 
# mtext(2, text = expression("Landings, 10"^3*'metric tons'),
#         line = 3.5, cex = 1.5, outer = F)
#   axis(2, at = seq(5e4,25e4,5e4), 
#        labels = c("50","100","150","200","250"),
#        las = 1, cex.axis = 1.5)
# 
# legend(1985,9e4,c("Ecosystem-wide","Managed species"),
#        col = c("black","indianred"),bty = "n", lwd = 3)

soe.plot(SOE.data.2018, "Time", "Total Landings MAB", stacked = NA,status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed landings MAB")
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = F)
```

## Recreational landings (from MAB risk assessment)

add to database then uncomment r plot
<!--
<!-- ```{r RecFood, fig.cap="A: Total recreational harvest, B: Harvest per angler  \\label{recfood}", echo = F, fig.height=3.5} -->
<!-- opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6)) -->
<!-- soe.plot(SOE.data[EPU %like% "MAB"], 'Time', 'Total_Harvest', rel.y.num = 0.8, stacked = 'A') -->
<!-- soe.plot(SOE.data[EPU %like% "MAB"], 'Time', 'Harvest.per.Angler', rel.y.num = 0.8, stacked = 'B') -->

<!-- soe.stacked.axis('Year', 'N Recreationally Harvested Fish',rel.y.text = 1) -->
<!-- ``` -->
-->
## Mid-Atlantic recreational catch
```{r rec_catch_MAB, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Recreational Seafood MA", stacked = NA, status = F, full.trend = T,
         scale.axis = 10^6,end.start = 2007)
soe.stacked.axis("Time",expression("Fish caught, 10"^6*" n"), outer = F)

```

## Bennet Indicators & Revenue

```{r 'Rev_Price_Vol_MAB' , echo = F, out.width = "450pt", fig.align='center'}
knitr::include_graphics(file.path(image.dir, 'Rev_Price_Vol_MAB.png'))

```

```{r 'price_ind_MAB' , echo = F, out.width = "450pt", fig.align='center'}
knitr::include_graphics(file.path(image.dir, 'price_ind_MAB.png'))
```

```{r 'vol_ind_MAB' , echo = F, out.width = "450pt", fig.align='center'}
knitr::include_graphics(file.path(image.dir, 'vol_ind_MAB.png'))
```
\newpage

<!-- ## Revenue (A: Apex Predator, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos) -->
<!-- ```{r Revenue_MAB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width=5.5, fig.height=8, fig.align='center'} -->
<!-- opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6)) -->

<!-- soe.plot(SOE.data.2018, "Time", "Apex Predator Revenue MAB", stacked = "A",status = F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007) -->
<!-- soe.plot(SOE.data.2018, "Time", "Piscivore Revenue MAB", stacked = "B",status = F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007) -->
<!-- soe.plot(SOE.data.2018, "Time", "Planktivore Revenue MAB", stacked = "C",status = F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007) -->
<!-- soe.plot(SOE.data.2018, "Time", "Benthivore Revenue MAB", stacked = "D",status = F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007) -->
<!-- soe.plot(SOE.data.2018, "Time", "Benthos Revenue MAB", stacked = "E",status =F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007) -->
<!-- #soe.plot(SOE.data.2018, "Time", "Total Revenue MAB", stacked = "F",status  = F, -->
<!-- #         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3) -->
<!-- soe.stacked.axis("Time",expression("Revenue 10"^6*" USD"), outer = T) -->

<!-- ``` -->

## Ecosystem-wide and managed species total revenue

```{r managed_revenue , echo = F, message=F, include=T, warning=F , fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))



soe.plot(SOE.data.2018, "Time", "Total Revenue MAB", stacked = NA,status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007, x.start = 1986,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed revenue MAB")
soe.stacked.axis("Time",expression("Revenue, 10"^6*'USD'), outer = F)
```


```{r prop_table,echo = F, results = 'asis', fig.width=5, eval=F, fig.align = 'center'}
library(stargazer)
landings <- SOE.data.2018[grepl("Landings MAB 2016 prop", SOE.data.2018$Var),]$Value[1:5]
joint_landings <- SOE.data.2018[grepl("Landings MAB 2016 prop", SOE.data.2018$Var),]$Value[6:10]

revenue <- SOE.data.2018[grepl("Revenue MAB 2016 prop", SOE.data.2018$Var),]$Value[1:5]
joint_revenue <- SOE.data.2018[grepl("Revenue MAB 2016 prop", SOE.data.2018$Var),]$Value[6:10]

df <- data.frame(Groups = c("Piscivore","Planktivore","Benthivore","Other","Benthos"),
                 landings = landings,
                 joint_landings = c(joint_landings[1],rep("-",4)),
                 revenue = revenue,
                 joint_revenue = c(joint_revenue[1],rep("-",4)))
#df <- df %>% filter(Groups != Other)

names(df) <- c("Groups", "MAB Landings", "MAB Joint Landings", "MAB Revenue",
               "MAB Joint Revenue")
stargazer(df, summary = F, rownames = T, title = "Proportion of catch managed by MAFMC (2016)", header = F)
```




## Mid-Atlantic fleet diversity and fleet count 
```{r fleet diversity MAB, echo=F, message=FALSE, warning=FALSE, include=T, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","Mid-Atlantic average fleet diversity", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007)
soe.plot(SOE.data.2018,"Time","Mid-Atlantic fleet count", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007)
soe.stacked.axis('Year', 'Commercial fleet diversity')
```

## Mid-Atlantic commercial species diversity

```{r revenue diversity MAB, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, 'Time', "Mid-Atlantic commercial species diversity",stacked = NA, 
         endshade = T, full.trend = F, status = F,end.start = 2007)
soe.stacked.axis("Year","Shannon Index", outer = F)
```

## Mid-Atlantic recreational opportunities (A: Rec participation, B: Angler trips)
```{r recreation MAB, echo=F, message=FALSE, warning=FALSE, include=T, fig.width=8, fig.height=6, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","Mid-Atlantic Rec participation", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6, status = F,end.start = 2007)
soe.plot(SOE.data.2018,"Time","Mid-Atlantic angler trips", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6, status = F,end.start = 2007)
soe.stacked.axis('Year', expression('Recreational Participation, 10'^6*'n'))
```



## Mariculture
```{r, mariculture MAB, echo = F, warning = F, include = T,fig.width=7, fig.height=4.25, fig.align='center'}
library(RColorBrewer)
topo <- c('black', "indianred", "darkorange")

oyst_vars <- list("aquaculture NJ gear raised oysters sold",
                 # "aquaculture NH oyster harvest N",
                  "aquaculture MD oyster harvest N",
                 # "aquaculture RI oyster harvest N",
                  "aquaculture VA oyster harvest N")
y.min <- 1
y.max <- 40000000
opar <- par(mar = c(4, 6, 2, 6))
plot(NULL, xlim = c(2005, 2017),
     ylim = c(y.min,y.max), xlab = 'Time', ylab = '', yaxt = "n",ty = 'n',
     cex.lab=1.5, las = 1, cex.axis = 1.5)
for (i in 1:length(oyst_vars)){

  ts <- SOE.data.2018[SOE.data.2018$Var == oyst_vars[[i]],]$Value
  years <- SOE.data.2018[SOE.data.2018$Var == oyst_vars[[i]],]$Time
  
  ts_oyster <- zoo(ts, years)
  points(ts_oyster, type = "o", lwd = 3, col = topo[i])


   
}
mtext(2, text = expression("Oysters Harvested, 10"^6*'n'),
        line = 3.5, cex = 1.5, outer = F)
  axis(2, at = c(1*10^6,5*10^6,10*10^6,15*10^6,
                 20*10^6,25*10^6,30*10^6,35*10^6,40*10^6), 
       labels = c("1","5","10","15","20",
                  "25","30","35","40"),
       las = 1, cex.axis = 1.5)
legend(2006, 30000000, legend = c("New Jersey",
                            "Maryland",
                            #"Rhode Island",
                            "Virginia"), col = topo, bty = "n",lwd = 2)

```



## Occurrence of algal blooms in Chesapeake Bay at cell concentrations greater than the NOAA threshold for consideration as a bloom event (black), and occurrence of blooms at concentrations warranting action by the Virginia Department of Health (red)

```{r hab_MAB, echo = F, warning = F, include = T,fig.width=7, fig.height=4.25, fig.align='center'}
opar <- par(mar = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "chesapeake bay HAB", stacked = NA,status = F,mean_line = F,
         endshade = F, rel.y.num = 1.1, full.trend = F, scale.axis = 1,end.start = 2007,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "HAB events at VDH threshold")
soe.stacked.axis("Time","Algal Bloom Events, n", outer = F)
```


## Commercial reliance and social vulnerability (MAB)

```{r 'commercial_reliance_and_vulnerability MAB' , echo = F, message=F, include=T, warning=F, fig.width=6, fig.height=7, fig.align = 'center'}
library(maps);library(mapdata);library(raster)
library(grid);library(colorRamps);library(stringr)

cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability MAB",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "commercial reliance MAB",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)
lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude MAB",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude MAB",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                     lat = lat,
                     cat3 = cat3)#,
                     #Value = mab$col)
#mab.dat <- mab.dat %>% group_by(Value) %>%
#  arrange(desc(Value))

#break up into groups for plotting - allows for effective layering
#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)

#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#get USA map data
usa<-getData('GADM', country="USA", level=0)

#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(usa, xlim = c(-77.5,-71), ylim = c(35,41),col = "grey")
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)

#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -73, xmx = -70.9, ymn = 36, ymx = 37.8, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)

#text
text(-73.3, 36.9, "Commercial Reliance",srt=90)
text(-72,35.8, "Social Vulnerability")
```

## Recreational reliance and social vulnerability (MAB)
```{r 'community_reliance_and_social_vulnerability MAB' , echo = F, message=F, include=T, warning=F, fig.width=6, fig.height=7, fig.align = 'center'}

cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability MAB",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "recreational reliance MAB",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)

lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude MAB",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude MAB",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                     lat = lat,
                     cat3 = cat3)#,
                     #Value = mab$col)
#mab.dat <- mab.dat %>% group_by(Value) %>%
#  arrange(desc(Value))

#break up into groups for plotting - allows for effective layering
#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)

#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#get USA map data
usa<-getData('GADM', country="USA", level=0)

#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(usa, xlim = c(-77.5,-71), ylim = c(35,41),col = "grey")
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)
#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -73, xmx = -70.9, ymn = 36, ymx = 37.8, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)

#text
text(-73.3, 36.9, "Recreational Reliance",srt=90)
text(-72,35.8, "Social Vulnerability")
```

## Species vulnerability (MAB)

```{r 'species_vulnerability_MAB' , echo = F, out.width = "450pt", fig.align='center'}
knitr::include_graphics(file.path(image.dir, 'Species_vulnerability_MAB.jpg'))
```

# Protected species-fishery interactions

## Harbor porpoise

```{r harbor_porpoise, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
#Harbor porpoise bycatch - Dropped mean line for clarity
soe.plot(SOE.data.2018, 'Time', "Harbor porpoise bycatch estimates",            
         scale.axis = 1, rel.y.num = 1.2, stacked = NA, status = F, endshade = T,
         end.start = 2007, suppressAxis = F, full.trend = F, point.cex = 1,ymax = F, y.upper = 2500, mean = F)
soe.stacked.axis('Year', expression('Harbor Porpoise Bycatch, n'), outer = F)


legend(2000, 2250, legend = "Potential Biological Removal", col = adjustcolor("red", .5), lwd = 3,
       bty = "n")

#credible intervals and PBI
lw_CI <- SOE.data.2018[SOE.data.2018$Var == 'Harbor porpoise bycatch 2.5 CI',]$Value
up_CI <- SOE.data.2018[SOE.data.2018$Var == 'Harbor porpoise bycatch 97.5 CI',]$Value
pbi <- SOE.data.2018[SOE.data.2018$Var == 'Harbor porpoise potential biological removal',]$Value
year <- SOE.data.2018[SOE.data.2018$Var == 'Harbor porpoise bycatch 97.5 CI',]$Time

points(year, pbi, type  = "l", lty = 1, col = adjustcolor("red", .5), lwd = 3)
points(year, lw_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .9), lwd = 2.5)
points(year, up_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .9), lwd = 2.5)
```

## Sea Turtles

## Right whale 
```{r rw_abundance, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, 'Time', "right_whale_median",            
         scale.axis = 1, rel.y.num = 1.2, stacked = NA, endshade = T,status = F,
         suppressAxis = F, full.trend = F, lwd = 1.5, point.cex = 1, end.start = 2007)
soe.stacked.axis('Year', expression('Median Right Whale Abundance, n'), outer = F)
lw_CI <- SOE.data.2018[SOE.data.2018$Var == 'right_whale_lower_95',]$Value
up_CI <- SOE.data.2018[SOE.data.2018$Var == 'right_whale_upper_95',]$Value
year <- SOE.data.2018[SOE.data.2018$Var == 'right_whale_upper_95',]$Time
points(year, lw_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .6), lwd = 2.5)
points(year, up_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .6), lwd = 2.5)

```

# Resource Species

## Trends in Biomass

## Fall Survey Biomass (MAB) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r fall_survey_MAB, echo = F, warning = F, include = T,out.width='1\\linewidth',fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Fall Biomass Index MAB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)
soe.plot(SOE.data.2018, "Time", "Planktivore Fall Biomass Index MAB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)
soe.plot(SOE.data.2018, "Time", "Benthivore Fall Biomass Index MAB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)
soe.plot(SOE.data.2018, "Time", "Benthos Fall Biomass Index MAB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)
#soe.plot(SOE.data.2018, "Time", "Total Fall Biomass MAB", stacked = "E",status  = F,
#         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```


## Spring Survey Biomass (MAB) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r Spring_survey_MAB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Spring Biomass Index MAB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.plot(SOE.data.2018, "Time", "Planktivore Spring Biomass Index MAB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.plot(SOE.data.2018, "Time", "Benthivore Spring Biomass Index MAB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.plot(SOE.data.2018, "Time", "Benthos Spring Biomass Index MAB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
#soe.plot(SOE.data.2018, "Time", "Total Spring Biomass MAB", stacked = "E",status  = F,
#         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```


## Species composition

## Ichthyoplankton Shannon diversity and species counts in the Spring (Top row) and Fall (bottom row)

```{r larval_diversity, out.width=c('9.5cm','9.5cm'), out.height=c('7cm','7cm'), fig.show='hold',fig.ncol = 2,warning=F, echo=F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time","Spring_Ich_Shannon Diversity Index", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 1, status=F)
soe.plot(SOE.data.2018, "Time","Fall_Ich_Shannon Diversity Index", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 1, status=F)
soe.stacked.axis('Year', expression('Shannon Index'), outer = T)

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))
soe.plot(SOE.data.2018, "Time","larval species count spring", stacked = "C",
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 1, status=F)
soe.plot(SOE.data.2018, "Time","larval species count fall", stacked = "D",
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 1, status=F)
soe.stacked.axis('Year', expression('Species Present, n'), outer = T)

```

## Species distribution


## Historical and current distributions, thermal habitat projections

### Black sea bass (KDE, contemporary, 20-40 year thermal habitat projection)
```{r black_sea_bass_MAB , echo = F, out.width=c('7cm','7cm','7cm'), out.height=c('6cm','7cm','7cm'), fig.show='hold',fig.ncol = 3}
knitr::include_graphics(file.path(image.dir, 'black_sea_bass_kde.png'))
knitr::include_graphics(file.path(image.dir, 'bsb_contemp.png'))
knitr::include_graphics(file.path(image.dir, 'bsb_20_40.png'))

```

## Black sea bass habitat distribution trends (Top row: Spring, bottom row: Fall)
```{r bsb_species_distributions_MAB, out.width=c('9.5cm','9.5cm'), out.height=c('7cm','7cm'), fig.show='hold',fig.ncol = 2,warning=F, echo=F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "black sea bass spring mean depth", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.plot(SOE.data.2018, "Time", "black sea bass fall mean depth", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, line.forward = T)
soe.stacked.axis("Time",expression("Mean depth, m"), outer = T)

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "black sea bass spring mean along-shelf dist", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3, suppressAxis = T, line.forward = T)
soe.plot(SOE.data.2018, "Time", "black sea bass fall mean along-shelf dist", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3)
soe.stacked.axis("Time",expression("Mean along-shelf distance, km"), outer = T)

```

### Summer flounder (KDE, contemporary, 20-40 year thermal habitat projection)
```{r 'summer_flounder_MAB' , echo = F, out.width=c('7cm','7cm','7cm'), out.height=c('6cm','7cm','7cm'), fig.show='hold',fig.ncol = 3}
knitr::include_graphics(file.path(image.dir, 'summer_flounder_kde.png'))
knitr::include_graphics(file.path(image.dir, 'summer_flounder_contemp.png'))
knitr::include_graphics(file.path(image.dir, 'summer_flounder_20_40.png'))
```

##Summer flounder habitat distribution trends (Top row: Spring, bottom row: Fall)
```{r sf_species_distributions_MAB, out.width=c('9.5cm','9.5cm'), out.height=c('7cm','7cm'), fig.show='hold',fig.ncol = 2,warning=F, echo=F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "summer flounder spring mean depth", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)
soe.plot(SOE.data.2018, "Time", "summer flounder fall mean depth", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, line.forward = T)
soe.stacked.axis("Time",expression("Mean depth, m"), outer = T)

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "summer flounder spring mean along-shelf dist", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3, suppressAxis = T, line.forward = T)
soe.plot(SOE.data.2018, "Time", "summer flounder fall mean along-shelf dist", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3)
soe.stacked.axis("Time",expression("Mean along-shelf distance, km"), outer = T)

```

##Summer flounder (left) and black sea bass (right) shelf habitat (Top row: Spring, bottom row: Fall)
```{r occupancy_MAB, out.width=c('9.5cm','9.5cm'), out.height=c('7cm','7cm'), fig.show='hold',fig.ncol = 2,warning=F, echo=F}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "summer flounder spring occupancy", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 10^3, suppressAxis = T)
soe.plot(SOE.data.2018, "Time", "summer flounder fall occupancy", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 10^3)
soe.stacked.axis("Time",expression("Habitat Area, 10"^3*" km"^2*''), outer = T)

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "black sea bass spring occupancy", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 10^3, suppressAxis = T)
soe.plot(SOE.data.2018, "Time", "black sea bass fall occupancy", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = F, scale.axis = 10^3)
soe.stacked.axis("Time",expression("Habitat Area, 10"^3*" km"^2*''), outer = T)
```
<!--
### Sea Scallop (KDE, contemporary, 20-40 year thermal habitat projection)

```{r 'sea_scallop_MAB' , echo = F, out.width=c('7cm','7cm','7cm'), out.height=c('6cm','7cm','7cm'), fig.show='hold',fig.ncol = 3}
knitr::include_graphics(file.path(image.dir, 'Sea_scallop_kde.png'))
knitr::include_graphics(file.path(image.dir, 'Sea_scallop_contemp.png'))
knitr::include_graphics(file.path(image.dir, 'Sea_scallop_20_40.png'))
```
-->

## Southern kingfish occurrences in the observer database

```{r southern kingfish, echo=F, message=FALSE, warning=FALSE ,fig.align='center', fig.height=7, fig.width=6}
PKG <-c("rgdal","raster","maptools","mapdata",
        "maps","colorRamps","fields","RColorBrewer")

for (p in PKG) {
  if(!require(p,character.only = TRUE)) {
    install.packages(p)
    library(p)  }
}

sk.dat <- SOE.data.2018[grepl("Lat",SOE.data.2018$Units) & grepl("Southern Kingfish",SOE.data.2018$Var),]
lon <- sk.dat[as.numeric(sk.dat$Value) < 0,]$Value
lat <- sk.dat[as.numeric(sk.dat$Value) > 0,]$Value

#create data.frame
df <- data.frame(year = sk.dat$Time,
                 lon = lon,
                 lat = lat)

#set color palette
colors1 <- adjustcolor(matlab.like2(8),.5)
colors2 <- adjustcolor(matlab.like2(8),.5)
colors3 <- adjustcolor(matlab.like2(8),.5)
colors4 <- adjustcolor(matlab.like2(8),1)
colors <- c(colors1[1:2], colors2[3:4], colors3[5:6],colors4[7:8])

#map values to colors
df <- df %>% arrange(year) %>% mutate(colors = plyr::mapvalues(year, from = c("2010","2011","2012","2013",
                                                                              "2014","2015","2016","2017"),
                                                               to = c(colors)))
colors <- df$colors


#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#get USA map data
usa<-getData('GADM', country="USA", level=0)

#data.frame to sp object
coordinates(df) <- ~lon+lat
df@proj4string <- map.crs
df <- spTransform(df, map.crs)

#plot
par(fig = c(0,1,0,1))
plot(usa, xlim = c(-76,-73), ylim = c(35,40.5),col = "grey")
plot(df, pch = 16, col = colors, add = T, cex = 2.5)


occur <- SOE.data.2018[SOE.data.2018$Var == "Southern Kingfish observer sightings",]$Value
time <- SOE.data.2018[SOE.data.2018$Var == "Southern Kingfish observer sightings",]$Time

ts <- zoo(occur,time)
par(fig = c(0.5,1, 0.1, .5), new = T, bty = "l",mar = c(5,6,3,1)) 
barplot(occur,time, col = matlab.like2(8), xlab = c("Time"),ylab = "S. Kingfish Occurrence, n",
        cex.lab = 1, las = 1, cex.axis = 1.1)
axis(1,at = seq(1250,18500,length.out = 8),labels = c("2010","2011","2012","2013",
                                            "2014","2015","2016","2017"), cex.axis=1)

```

# Ecosystem Conditions and Productivity

## Observed ocean conditions

## Long-term SST 

```{r long_term_sst,  echo=F, message=FALSE, warning=FALSE , fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time", "long term SST jan-jun",
         endshade = T, status = F,end.start = 2007, line.forward = TRUE)
soe.stacked.axis("Time",expression(paste("Mean SST (",degree,"C)")), outer = F)

```

### SST (A), primary production (B), and Chl a (C) over 2017 (colored polygons) compared against long-term mean (black line) and +/- 1 standard deviation (grey polygon)

```{r SST_PPD_CHL, echo = F, out.width=c('6.5cm','6.5cm','6.5cm'), out.height=c('7cm','7cm','7cm'), fig.show='hold',fig.ncol = 3}

## SST
doy <- as.numeric(SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 MAB",]$Time)
val_2017 <- SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 MAB",]$Value
val_LT <- SOE.data.2018[SOE.data.2018$Var == "sst mean long term MAB",]$Value
val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sst sd long term MAB",]$Value


val_2017 <- approx(doy,val_2017, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT <- approx(doy,val_LT, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT_sd <- approx(doy,val_LT_sd, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
doy <- seq(doy[1],doy[length(doy)],length.out = 365*1)


above_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT[i]){
    above_mean[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i]){
    below_mean[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT_sd[i] + val_LT[i]){
    above_sd[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT_sd [i] + val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i] - val_LT_sd[i]){
    below_sd[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT[i] - val_LT_sd [i]){
    below_sd[i] <- NA
  }
}

#Lines for polygons
above_sd[is.na(above_sd)] <- val_LT_sd[which(is.na(above_sd))] + val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- val_LT[which(is.na(below_sd))] - val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- val_LT[which(is.na(below_mean))]

upper <- val_LT_sd + val_LT
lower <- val_LT - val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]), ylim = c(2,26.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,61,122,183,245,306,365), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Mean SST (",degree,"C)")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(15,26.5*.95,"A",cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-val_LT), rev(above_mean)),
        col = "orange", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(val_LT + val_LT_sd)), rev(above_sd)),
        col = "red", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(val_LT - val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,val_LT, type = "l", lwd = 1, "grey90")
#points(doy,val_2017, type = "l", lwd = .5, "black")



## primary production
doy <- seq(1,52,1)
ppd_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd 2017 MAB",]$Value
ppd_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd long term MAB",]$Value
ppd_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd ppd long term MAB",]$Value

above_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT[i]){
    above_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i]){
    below_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT_sd[i] + ppd_val_LT[i]){
    above_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT_sd [i] + ppd_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i] - ppd_val_LT_sd[i]){
    below_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT[i] - ppd_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- ppd_val_LT_sd[which(is.na(above_sd))] + ppd_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- ppd_val_LT[which(is.na(below_sd))] - ppd_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- ppd_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- ppd_val_LT[which(is.na(below_mean))]

upper <- ppd_val_LT_sd + ppd_val_LT
lower <- ppd_val_LT - ppd_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Primary Production (gC m"^-2*"d"^-1*")")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(2,2.5*.95,"B", cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (ppd_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-ppd_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(ppd_val_LT + ppd_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(ppd_val_LT - ppd_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,ppd_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,ppd_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)

## Chlorophyll a
chl_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl 2017 MAB",]$Value
chl_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl long term MAB",]$Value
chl_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd chl long term MAB",]$Value

above_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT[i]){
    above_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i]){
    below_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT_sd[i] + chl_val_LT[i]){
    above_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT_sd [i] + chl_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i] - chl_val_LT_sd[i]){
    below_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT[i] - chl_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- chl_val_LT_sd[which(is.na(above_sd))] + chl_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- chl_val_LT[which(is.na(below_sd))] - chl_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- chl_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- chl_val_LT[which(is.na(below_mean))]

upper <- chl_val_LT_sd + chl_val_LT
lower <- chl_val_LT - chl_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Chl ",alpha," mg m"^-3*"")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)

# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (chl_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-chl_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(chl_val_LT + chl_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(chl_val_LT - chl_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,chl_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,chl_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)
text(2,2*.95,"C", cex = 1.5)
```

## Sea surface temperature maps

## 2017 Spatial SST Anomaly

```{r '2017_SST_Anomaly_Maps' , echo = F, out.width='10cm', out.height='10cm', fig.show='hold'}
knitr::include_graphics(file.path(image.dir, 'Winter_2017_SST_Anomaly.png'))
knitr::include_graphics(file.path(image.dir, 'Spring_2017_SST_Anomaly.png'))
```
```{r '2017_SST_Anomaly_Maps_2' , echo = F, out.width='10cm', out.height='10cm', fig.show='hold'}
knitr::include_graphics(file.path(image.dir, 'Summer_2017_SST_Anomaly.png'))
knitr::include_graphics(file.path(image.dir, 'Fall_2017_SST_Anomaly.png'))
```



## Zooplankton (MAB)

```{r, MAB zooplankton, echo = F, warning = F, include = T, fig.width=7, fig.height=9, fig.align='center', warning=F}
opar<-par(mar=c(1,1,1,4),mfrow = c(2,1))

mab_prim_prod <- finder(SOE.data.2018, "Primary Production ratio anomaly MAB")
mab_copepod_anom <- finder(SOE.data.2018, "mean small-large index ALL")

usr <- par("usr")
opar <- par(mar = c(5,4.75,4,4.75))
with(SOE.data.2018[SOE.data.2018$Var == mab_copepod_anom,], plot(Time[10:39], Value[10:39],
       type = "o", col = "black", ylim = c(-1.5,1.5), pch = 16, lwd = 3,
       cex = 1.2, ylab = "", las = 1, xaxt = "n", cex.axis = 1.2, xlab = ""))

mtext(side = 2, line = 3, "Small-Lg Copepod Index", cex = 1.2)
text(1986,1.4,"A",cex = 1.75)
par(new = T)
 
with(SOE.data.2018[SOE.data.2018$Var ==  mab_prim_prod[1],], plot(Time, Value,
       type = "o", col =  "springgreen2", ylim = c(.75,1.25), ylab = "", axes = F,log = "y",
       yaxt = "n", pch = 16, lwd = 3, cex = 1.2, las = 1, xaxt = "n",xlab = ""))
  
axis(side = 4, las = 1, cex.axis = 1.2)
axis(side = 1, cex.axis = 1.2)
mtext(side = 4, line = 3, "Mean Primary Production Ratio", cex = 1.2)
mtext(side = 1, line = 3, "", cex = 1.2)
legend("bottomright",
         legend = c("Copepod Index", "Prim. Prod. Ratio"), col = c("black","springgreen2"),
         bty = "n", lwd = 3)

soe.plot(SOE.data.2018, "Time", "Centropages typicus abundance anomaly MAB", 
         full.trend = T, endshade = T, stacked = "B", suppressAxis = T, x.start = 1986)
soe.stacked.axis("Time","Abundance anomaly", outer = F, rel.x.text = 1.2,
                 rel.y.text = 1.2, y.line = 3.1)
```

#Primary production and chlorophyll anomaly maps
```{r 'PPD_maps_MAB' , echo = F, out.width='10cm', out.height='10cm', fig.show='hold'}
knitr::include_graphics(file.path(image.dir, 'PPD_anom_MAB.png'))
knitr::include_graphics(file.path(image.dir, 'CHL_anom_MAB.png'))
```


## Groundfish condition (MAB)

```{r 'condition factor MAB' , echo = F, out.width = "450pt", fig.align='center'}
knitr::include_graphics(file.path(image.dir, 'MAFMC_Fish_Condition_2018.jpg'))
```

## Groundfish productivity (A: MAFMC managed species, B: Commercial MAB Species)

```{r groundfish productivity,  echo = F, out.width='9.2cm', out.height='9.2cm', fig.show='hold', fig.align = 'center'}
## Functions for plotting
library(ggplot2)
library(rpart)

#### Adjust plot properties -------------------------------
adjustAxes <- 
  ggplot2::theme(axis.title   = element_text(size = 18),
                 axis.text    = element_text(size = 15),
                 plot.title   = element_text(size = 20))

ggplot <- function(...) { ggplot2::ggplot(...)  + 
    ggplot2::theme_bw() + 
    adjustAxes}


#### Plot stacked bar with cpts for single var ------------
plot_stackbarcpts_single <- function(YEAR, var2bar,
                                     x, xlab, ylab,
                                     titl,
                                     file_suffix,
                                     leg_font_size = 10,
                                     remove_leg = FALSE,
                                     leg_ncol = 1,
                                     wcpts = TRUE,
                                     wdashed = TRUE,
                                     height = 5.5,
                                     width = 8,
                                     filt = TRUE,
                                     label = label,
                                     y.text = y.text) {
  
  dat2bar <- data.frame(YEAR, var2bar,
                        x)
  if (filt == TRUE){mab_species <-  list("SUMMER FLOUNDER","SCUP","BLACK SEA BASS","BLUEFISH",
                                         "NORTHERN SHORTFIN SQUID", "LONGFIN SQUID", "ATLANTIC MACKEREL",
                                         "BUTTERFISH","ATLANTIC SURFCLAM", "OCEAN QUAHOG", "TILEFISH",
                                         "BLUELINE TILEFISH","SPINY DOGFISH", "GOOSEFISH")
  dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar)) %>%
    filter(var2bar %in% mab_species)
} else if (filt == FALSE){
    dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar))
}
  p <-   
    ggplot(dat2plot,
           aes(x = YEAR)) +
    geom_bar(data = dat2plot %>% filter(value > 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_bar(data = dat2plot %>% filter(value < 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_hline(size = 0.3, aes(yintercept = 0)) +
    xlab(xlab) +
    ylab(ylab) +
    ggtitle(titl) +
    guides(fill = guide_legend(ncol = leg_ncol)) +
    theme(axis.title   = element_text(size = 16),
          axis.text    = element_text(size = 15),
          plot.title   = element_text(size = 20),
          legend.text  = element_text(size = leg_font_size),
          legend.title = element_blank()) +
    annotate("text", label = label, x = 1980, y = y.text,size = 8, colour = "black")
  
  if(remove_leg) p <- p + theme(legend.position = "none")
  
  print(p)
  
  #ggsave(plot = p,
  #       filename = "./productivity_all.eps",
  #       width = width,
  #       height = height)
}

bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "MAB",]
plot_stackbarcpts_single(YEAR = bar_dat$Time,
                         var2bar = bar_dat$Var,
                         x = bar_dat$Value,
                         titl = "",
                         xlab = "",
                         ylab = "Small fish per large fish biomass (anomaly)",
                         height = 5.5,
                         width = 9,
                         filt = TRUE,
                         label = "A",
                         y.text = 4.5)

bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "MAB",]
plot_stackbarcpts_single(YEAR = bar_dat$Time,
                         var2bar = bar_dat$Var,
                         x = bar_dat$Value,
                         titl = "",
                         xlab = "",
                         ylab = "Small fish per large fish biomass (anomaly)",
                         height = 5.5,
                         width = 9,
                         filt = FALSE,
                         label = "B",
                         y.text = 10)
```


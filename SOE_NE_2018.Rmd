---
title: "State of the Ecosystem - Mid-Atlantic Bight"
author: "Northeast Fisheries Science Center"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    keep_tex: yes
    pandoc_args: --latex-engine=xelatex
    toc: no
  html_document:
    toc: yes
  word_document:
    toc: no
fontsize: 11pt
geometry: margin=1cm
---

```{r Directory and Data Set-up, echo=F, message=F, warning=FALSE, paged.print=TRUE}
#data.dir  <- '/home/slucey/EcoAP/SOE2017/data'
#image.dir <- '/home/slucey/EcoAP/SOE2017/images'
#data.dir <- 'Z:\\SOE2017\\data'
#image.dir <- 'Z:\\SOE2017\\images'
data.dir  <- "F:/SOE/SOE_data"
image.dir <- "F:/SOE/SOE_data"
#data.dir  <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018'
#image.dir <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018/images'
library(data.table); library(Kendall)
load(file.path(data.dir, "SOE_data_2018.Rdata"))
knitr::opts_chunk$set(echo = FALSE)

map_figs = T
```

```{r libraries, echo=F, message=F, warning=FALSE, paged.print=TRUE}
library(Kendall);library(data.table);library(zoo)
library(dplyr);library(nlme);library(AICcmodavg)
library(colorRamps);library(Hmisc);library(rgdal)
library(maps);library(mapdata);library(raster)
library(grid);library(stringr)


#import map polygons
#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#get USA map data
can <- readOGR(dsn = "canada_shape_files", verbose = F)
can@proj4string <- map.crs
usa <- readOGR(dsn = "usa_shape_files", verbose = F)
usa@proj4string <- map.crs
```


```{r libraries and functions, include=F, echo = F}

#load("SOE_data_2018.Rdata")

fit_lm <- function(dat) {
  # Remove missing values first so that all models
  # use the same number of observations (important for AIC)
  # dat <- dat %>% dplyr::filter(complete.cases(.))
  
  # Constant model (null model used to calculate 
  # overall p-value)
  constant_norm <-
    nlme::gls(series ~ 1, 
              data = dat)
  
  constant_ar1 <-
    try(nlme::gls(series ~ 1,
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(constant_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA)) 
  } 
  
  
  
  # Linear model with normal error
  linear_norm <- 
    nlme::gls(series ~ time, 
              data = dat)
  
  # Linear model with AR1 error
  linear_ar1 <- 
    try(nlme::gls(series ~ time, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(linear_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Polynomial model with normal error
  dat$time2 <- dat$time^2
  poly_norm <- 
    nlme::gls(series ~ time + time2, 
              data = dat)
  
  # Polynomial model with AR1 error
  poly_ar1 <- 
    try(nlme::gls(series ~ time + time2, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(poly_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Calculate AICs for all models
  df_aicc <-
    data.frame(model = c("poly_norm",
                         "poly_ar1",
                         "linear_norm",
                         "linear_ar1"),
               aicc  = c(AICc(poly_norm),
                         AICc(poly_ar1),
                         AICc(linear_norm),
                         AICc(linear_ar1)),
               coefs = rbind(coef(poly_norm),
                             coef(poly_ar1),
                             c(coef(linear_norm), NA),
                             c(coef(linear_ar1),  NA)),
               # Calculate overall signifiance (need to use
               # ML not REML for this)
               pval = c(anova(update(constant_norm, method = "ML"),
                              update(poly_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(poly_ar1, method = "ML"))$`p-value`[2],
                        anova(update(constant_norm, method = "ML"),
                              update(linear_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(linear_ar1, method = "ML"))$`p-value`[2]))
  
  best_lm <-
    df_aicc %>%
    dplyr::filter(aicc == min(aicc))
  
  
  if (best_lm$model == "poly_norm") {
    model <- poly_norm
  } else if (best_lm$model == "poly_ar1") {
    model <- poly_ar1
  } else if (best_lm$model == "linear_norm") {
    model <- linear_norm
  } else if (best_lm$model == "linear_ar1") {
    model <- linear_ar1
  }
  
  return(list(p = best_lm$pval,
              model = model))
}


#Plot new figure - Set end.start to 10 years before end of time series

soe.plot <- function(data, x.var, y.var, x.label = '', y.label = '', tol = 0.1,
                     x.start = NA, x.end = NA, end.start = 2008, bg.col = background, mean_line = T,
                     end.col = recent, stacked = NA, x.line = 2.5, y.line = 3.5, scale.axis = 1,
                     rel.y.num = 1.5, rel.y.text = 1.5, suppressAxis = FALSE,status  = F,anomaly = F,
                     endshade = TRUE, full.trend = TRUE, point.cex = 1.5, lwd = 2, ymax = TRUE,y.min = TRUE,
                     y.upper = y.upper, y.lower = y.lower, extra = FALSE, x.var2 = x.var2, y.var2 = y.var2,
                     line.forward = FALSE, mean_line.2 = T) {
  
  #print("You'll need to remove or interpolate NA values before this function will work")
  
  #Select Data
  x <- data[Var == y.var, ]
  x <- x[order(x[, get(x.var)]), ]
  setnames(x, x.var, 'X')
  
  #Set common time step if necessary
  if(is.na(x.start)) x.start <- min(x[, X])
  if(is.na(x.end))   x.end   <- max(x[, X])
  x <- x[X >= x.start, ]
  
  #Set up plot parameters
  if (ymax == TRUE){
    y.max <- max(x[, Value]) + tol * max(x[, Value])
  } else {
    y.max <- as.numeric(y.upper)
  }
  
  if (y.min == TRUE){
    y.min <- min(x[, Value]) - tol * abs(min(x[, Value]))
  } else if (y.min == FALSE){
    y.min <- as.numeric(y.lower)
  }
  
  y.mean <- mean(x[, Value])
  y.sd <- sd(x[, Value])
  
  #Plot blank plot
  plot(x[X >= x.start, list(X, Var)], xlim = c(x.start, x.end),
       ylim = c(y.min,y.max), xlab = '', ylab = '', axes = F, ty = 'n')
    #Add grides

  #Add background
  u <- par('usr')
  rect(u[1], u[3], u[2], u[4], border = NA, col = bg.col)

  #Add end period shading
  if (endshade == TRUE){
    rect(end.start - 0.5, u[3], u[2], u[4], border = NA, col = end.col)
    abline(h = u[3], lwd=3)
    abline(v = u[1], lwd=3)
  } else {
    abline(h = u[3], lwd=3)
    abline(v = u[1], lwd=3)
  }
  
  if (anomaly == F){
      if (mean_line == TRUE){
      abline(h = y.mean, col = 'grey', lwd = 3, lty = 2)
      } 
  } else if (anomaly == TRUE){
      abline(h = 0, col = 'grey', lwd = 3, lty = 2)
    }
  
  #Add data points/lines
  points(x[, list(X, Value)], pch = 16, cex = point.cex)
  lines( x[, list(X, Value)], lwd = lwd)
  
  #extra lines
  if (extra == TRUE){
    x2 <- data[Var == y.var2, ]
    x2 <- x2[order(x2[, get(x.var2)]), ]
    setnames(x2, x.var2, 'X2')
    x2 <- x2[X2 >= x.start, ]
    if (mean_line.2 == TRUE){
     abline(h = mean(x2[, Value]), col = 'lightcoral', lwd = 3, lty = 2) 
    }
    points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
    lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
    }
    
  
  #Add axis
  if (suppressAxis == FALSE){
    if(is.na(stacked)) axis(1, cex.axis = 1.5)
    if(!is.na(stacked)){
      if(stacked!= 'A') axis(3, cex.axis = 1.5, tck = 0.1, labels = F)
    }
  }

  #Stacked axes with 0 overlap so need to remove
  labels <- axTicks(2) / scale.axis
  if(labels[1] == 0) labels[1] <- ''
  axis(2, at = axTicks(2), labels = labels, cex.axis = rel.y.num,
       las = T)
  
  #Final portion of time series
  if (status == T){
    l10_x <- x[X > (end.start - 1), X]
    l10_y <- x[X > (end.start - 1), Value]
    lmod <- lm(l10_y ~ l10_x)
    lmod_c <- unlist(lmod[1])
    lmod_i <- lmod_c[1]
    lmod_s <- lmod_c[2]
    if(lmod_s > 0){
      lines(l10_x, lmod_s * l10_x + lmod_i,
            col = main.pos, lwd=5)
    }
    if(lmod_s < 0){
      lines(l10_x, lmod_s * l10_x + lmod_i,
            col = main.neg, lwd=5)
    }
  }

    #Add axis labels
    if(!is.na(stacked)) text(u[1], u[4], labels = stacked, cex = 2, adj = c(-0.5, 1.5))
    if(is.na(stacked)){
      mtext(1, text = x.label, line = x.line, cex = 1.5)
      mtext(2, text = y.label, line = y.line, cex = rel.y.text)
    }
  
  if (full.trend == T){
    #Split data into past decade and full time series
    dat <- as.data.frame(x[, list(X, Value)])
    
    dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
    # Fit linear model
    lm_out <- fit_lm(dat = dat)
    p <- lm_out$p
    if (p < .05){
        
      newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
      newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
      lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

      year <- seq(x$X[1],x$X[length(x$X)],length.out = length(dat$time))
      # Make plot
      if (lm_pred$fit[length(lm_pred$fit)] > (lm_pred$fit[1] + lm_pred$fit[1]*.1)){
        lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
      } else if (lm_pred$fit[length(lm_pred$fit)] < (lm_pred$fit[1] - lm_pred$fit[1]*.1)){
        lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        }
      } else {
        lines(year, lm_pred$fit, col = "#ffffbf", lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex, col = "indianred")
        lines( x[, list(X, Value)], lwd = lwd, col = "indianred")
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
        }
    }
    
    if (extra == TRUE){
      
      # Second variable
      dat <- as.data.frame(x2[, list(X2, Value)])
    
      dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
     # Fit linear model
      lm_out <- fit_lm(dat = dat)
      p <- lm_out$p
      points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
      lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
      if (p < .05){
    
        newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
        newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
        lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

        year <- seq(x2$X2[1],x2$X2[length(x2$X2)],length.out =length(dat$time))
    # Make plot
        if (lm_pred$fit[length(lm_pred$fit)] > (lm_pred$fit[1] + lm_pred$fit[1]*.1)){
          lines(year, lm_pred$fit, col = main.pos, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else if (lm_pred$fit[length(lm_pred$fit)] < (lm_pred$fit[1] - lm_pred$fit[1]*.1)){
          lines(year, lm_pred$fit, col = main.neg, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else {
          lines(year, lm_pred$fit, col = "#ffffbf", lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        }
     }
    }

  }
 
}  


#Add axis labels for stacked plots
soe.stacked.axis <- function(x.label, y.label, x.line = 2.5,rel.x.text = 1.5,
                             y.line = 3.5, rel.y.text = 1.5, outer = TRUE){
  axis(1, cex.axis = rel.x.text)
  mtext(1, text = x.label, line = x.line, cex = 1.5, outer = outer)
  mtext(2, text = y.label, line = y.line, cex = rel.y.text, outer = outer)
  
}


#Background colors
background   <- 'white'
recent       <- '#E6E6E6'
main.pos <- rgb(253/255, 184/255, 99/255,  alpha = .9)
main.neg <- rgb(178/255, 171/255, 210/255, alpha = .9)

#Finder function for quickly finding variables based on partial match
finder <- function(data, match = match, factor = T){
  found <- unique(data[grepl(match,data$Var),]$Var)
  if (factor == T){
    return(found)
  } else {
    return(as.character(found))
  }
  
}


```
##Coneptual model 
```{r, fig.cap="Gulf of Maine and Georges Bank Ecosystem \\label{conceptual}", fig.height=6, fig.width=4, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
knitr::include_graphics(file.path(image.dir, 'GBandGOM_simple.png'))

```

\clearpage

# Objectives

\begin{table}[ht]
 \caption{Gulf of Maine and Georges Bank Ecosystem Objectives}
\centering
\begin{tabular}{lll}
  \hline
 & Objective Categories & Indicators reported here \\
  \hline
   & Seafood production & Landings by feeding guild \\
   & Profits & Revenue by feeding guild \\
   & Recreation & Number of anglers and trips \\
   & Stability & Diversity indices (fishery and species) \\
   & Social-Cultural & Community vulnerability, fishery engagement and reliance \\
   & Biomass & Biomass or abundance by feeding guild from surveys \\
   & Productivity & Condition and recruitment of NEFMC managed species \\
   & Trophic structure & Relative biomass of feeding guilds, primary productivity \\
   & Habitat & Thermal habitat projections, estimated habitat occurrence \\
   \hline
\end{tabular}
\end{table}

```{r, fig.cap="Summary of single species status for NEFMC stocks \\label{KOBE}", fig.height=7, fig.width=7, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
#knitr::include_graphics(file.path(image.dir, 'MAFMC_joint_stocks_2017.pdf'))

dat <- read.csv("2017assess.csv")

stocks <- unique(dat$Entity.Name)
n.stocks <- length(stocks)

decoder <- read.csv(file.path(data.dir,"2017decoder.csv"))
# set up the headers for most.recent structure - will contain oldest Assessment.Year
most.recent <- dat[1,]
most.recent <- most.recent[-1,]

for (i in 1:n.stocks){
  temp <- dat[dat$Entity.Name == decoder$Entity.Name[i],]
  most.recent <- rbind(most.recent,temp[temp$Assessment.Year == max(temp$Assessment.Year),])
}
#cbind(n.stocks,length(most.recent[,1]))

# get the max of F.Flimit and F.Fmsy and the max of B.Blimit and B.Bmsy
Frat <- most.recent$F.Fmsy
Brat <- most.recent$B.Bmsy
#Frat[6] <- most.recent$F.Flimit[6]  # Ocean Quahog use Flimit because no Fmsy
#Frat[18] <- 0.88  # hardwire average of the two GOM models for GOM cod
#Brat[18] <- 0.155 # hardwire average of the two GOM models for GOM cod
#model averages have been calculated and included in F/Fmsy column in 2017assess.csv
#cbind(most.recent$Entity.Name,most.recent$F.Flimit,most.recent$F.Fmsy)

# figure out appropriate range for axes WARNING HARD CODED
#max(Frat,na.rm=T)
#max(Brat,na.rm=T)
x.r <- c(0,4)
y.r <- c(0,3)

# set some colors
my.col <- rep(NA,n.stocks)
MA.col <- "blue"
NE.col <- "blue"
BO.col <- "purple"
for (i in 1:n.stocks){
  if(decoder$Council[i] == "MAFMC") my.col[i] <- MA.col
  if(decoder$Council[i] == "NEFMC") my.col[i] <- NE.col
  if(decoder$Council[i] == "Both")  my.col[i] <- BO.col
}

# create new matrix for plotting
xx <- as.data.frame(cbind(decoder[,2:8],Frat,Brat,my.col))
newlist <- as.factor(decoder$Code)
others <- as.factor("7 Skates")
sppcodes <- unlist(list(newlist, others))
MA.unknown <- sppcodes[c(1,3,4,47,48)] #mackerel, Loligo, Illex, monkfish unknown
#MA.unknown <- decoder$Code[c(1,3,4,8)] #BSB known
#NE.unknown <- c(decoder$Code[c(14,23,33)],"7 Skates")
NE.overfished <- sppcodes[c(17,19)] # GB cod, halibut
NE.unknown <- sppcodes[c(14,23,33,35,37,47,48,50)] #Red deepsea crab,  Offshore hake, GOM winter flounder, Witch flounder, GB YT,2 monkfish, 7 skates unknown


# break out the Councils
MA <- xx[xx$Council == "MAFMC",]
NE <- xx[xx$Council == "NEFMC",]
BO <- xx[xx$Council == "Both",]
MABO<-rbind(MA, BO)
NEBO<-rbind(NE, BO)

#if(saveplots) png(file = "MAFMC_joint_stocks_2017.png",  units="in", width = 6, height = 6, res=1200)
# plot(MABO$Brat,MABO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[c(1:11,47:49)])
#   abline(v=0.5,lty=2)
#   abline(v=1,lty=3)
#   abline(h=1,lty=2)
#   title(expression("MAFMC " * phantom("and Joint Stocks")), col.main="blue")
#   title(expression(phantom("MAFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
#   title(expression(phantom("MAFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
#   title(expression(phantom("MAFMC and Joint") * " Stocks"), col.main="black")  
#   legend('topright',legend=MA.unknown,pch=NA,text.col=my.col[c(1,3,4,47,48)], title="Unknown Status", title.col = "black")
#   text(MABO$Brat,MABO$Frat,labels=MABO$Code,pos=MABO$my.pos3,col=my.col[c(1:11,47:49)],cex=0.8)
#if(saveplots) savePlot("MAFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

#if(saveplots) pdf(file = "NEFMC_joint_stocks.pdf",  width = 6, height = 6)
#if(saveplots) png(file = "NEFMC_joint_stocks.png",  units="in", width = 6, height = 9, res=1200)
plot(NEBO$Brat,NEBO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[12:49])
   abline(v=0.5,lty=2)
   abline(v=1,lty=3)
   abline(h=1,lty=2)
   title(expression("NEFMC " * phantom("and Joint Stocks")), col.main="blue")
   title(expression(phantom("NEFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
   title(expression(phantom("NEFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
   title(expression(phantom("NEFMC and Joint") * " Stocks"), col.main="black")
   legend('topright',legend=NE.overfished,pch=NA,title="Overfished, F \nStatus Unknown",bty="n", text.width=strwidth("Offshore Hake"), inset=c(0,.05))
   legend(3,2.5,legend=NE.unknown,pch=NA,title="Unknown Status", bty="n")
   text(NEBO$Brat,NEBO$Frat,labels=NEBO$Code,pos=NEBO$my.pos3,col=my.col[12:49],cex=0.8)
#if(saveplots) savePlot("NEFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

```

## Changes for 2018


# Species Groupings

\begin{table}[ht]
 \caption{Gulf of Maine and Georges Bank Feeding Guilds}
\centering
\newcommand{\splat}{\vrule width 0 pt height 15pt depth 5pt\relax}
\begin{tabular}{lp{2.75in}cp{2.5in}}
  \hline
 & Feeding group & N species & Major species in group \\
  \hline
\splat & \textbf{A: Apex Predator} (Highest trophic level) & 4 & shark (Unc.), swordfish, yellowfin and bluefin tuna \\

\splat & \textbf{B: Piscivore} (Eat fish) & 23 & monkfish, winter and thorny skates, silver and offshore hake, Atlantic cod, halibut, fourspot flounder, spiny
dogfish, summer flounder, bluefish, striped bass, weakfishs \\

\splat & \textbf{C: Planktivore} (Eat plankton) & 16 & Atlantic herring, butterfish, Atlantic mackerel, menhaden, river herrings, shad, white hake, longfin and shortfin squids, searobins, sculpin, lumpfish \\

\splat & \textbf{D: Benthivore} (Eat bottom dwellers) & 25 & lobster, haddock, yellowtail, winter, and witch flounders,barnoor skate, ocean pout, black sea bass, scup, tilefish,
tautog, cunner, blue crab, red crab, other crabs \\

\splat & \textbf{E: Benthos} (Bottom dwellers) & 9 & scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars and urchins \\
   \hline
\end{tabular}
\end{table}

\clearpage

```{r prop_table_NE,echo = F, results = 'asis', fig.width=5, eval=F, fig.align = 'center',eval = F}
#Use this to create table of proportion of landings/revenue derived from NEFMC species (produces latex. Set eval = F)
library(stargazer)
gom_landings <- SOE.data.2018[grepl("GOM Landings 2016", SOE.data.2018$Var),]$Value
joint_gom_landings <- SOE.data.2018[grepl("GOM Joint Landings 2016", SOE.data.2018$Var),]$Value

gb_landings <- SOE.data.2018[grepl("GB Landings 2016", SOE.data.2018$Var),]$Value
joint_gb_landings <- SOE.data.2018[grepl("GB Joint Landings 2016", SOE.data.2018$Var),]$Value

gom_revenue <- SOE.data.2018[grepl("GOM Revenue 2016", SOE.data.2018$Var),]$Value
joint_gom_revenue <- SOE.data.2018[grepl("GOM Joint Revenue 2016", SOE.data.2018$Var),]$Value

gb_revenue <- SOE.data.2018[grepl("GB Revenue 2016", SOE.data.2018$Var),]$Value
joint_gb_revenue <- SOE.data.2018[grepl("GB Joint Revenue 2016", SOE.data.2018$Var),]$Value

 df <- data.frame(Groups = c("Piscivore","Benthivore","Planktivore","Benthos"),
                  gom_landings = gom_landings+joint_gom_landings,
                  gb_landings = gb_landings+joint_gb_landings,
                 
                  gom_revenue = gom_revenue + joint_gom_revenue,
                  gb_revenue = gb_revenue + joint_gb_revenue) 
                 

names(df) <- c("Groups", "GOM Landings", "GB Landings", "GOM Revenue",
                "GB Revenue")
stargazer(df, summary = F, rownames = T, title = "Proportion of catch managed by NEFMC (2016)", header = F)
```
# Human Dimensions

## Seafood Production
\begin{table}[ht]
  \caption{Proportion of catch managed by NEFMC (2016)}
\centering
\newcommand{\splat}{\vrule width 0 pt height 15pt depth 2pt\relax}
\begin{tabular}{lp{1.25in}cccc}
\hline
 & Groups & GOM Landings & GB Landings & GOM Revenue & GB Revenue \\
\hline \\
\splat & Piscivore & $0.98$ & $0.98$ & $0.93$ & $0.91$ \\
\splat & Planktivore & $0.89$ & $0.9$ & $0.89$ & $0.77$ \\
\splat & Benthivore & $0.05$ & $0.42$ & $0.03$ & $0.26$ \\
\splat & Benthos & $0.30$ & $0.30$ & $0.71$ & $0.85$ \\
\hline \\[-1.8ex]
\end{tabular}
\end{table}

#Seafood production

## NEFMC seafood specific landings (red) and total commericial landings (black) (A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos)
### Gulf of Maine
```{r seafood_landings_GOM, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

## Ecosystem-wide and managed species total landings
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time","Apex Predator Landings GOM", stacked = "A",status = F,mean_line = T,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007,
         y.min = FALSE, y.lower = 0)

soe.plot(SOE.data.2018, "Time", "Piscivore Landings GOM", stacked = "B",status = F,mean_line = T,
         mean_line.2 = T,endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time",
         y.var2 = "Piscivore NEFMC managed species sea food GOM")

soe.plot(SOE.data.2018, "Time", "Planktivore Landings GOM", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, mean_line = T,
         mean_line.2 = T, y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time",
         y.var2 = "Planktivore NEFMC managed species sea food GOM")

soe.plot(SOE.data.2018, "Time", "Benthivore Landings GOM", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,mean_line = T,
         mean_line.2 = T,y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time",
         y.var2 = "Benthivore NEFMC managed species sea food GOM")

soe.plot(SOE.data.2018, "Time", "Benthos Landings GOM", stacked = "E",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         mean_line = T,mean_line.2 = T, y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time",
         y.var2 = "Benthos NEFMC managed species sea food GOM")

soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)

```
### Georges Bank
```{r seafood_landings_GB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

## Ecosystem-wide and managed species total landings
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time","Apex Predator Landings GB", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007,
         y.min = FALSE, y.lower = 0, mean_line = T )

soe.plot(SOE.data.2018, "Time", "Piscivore Landings GB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, 
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Piscivore NEFMC managed species sea food GB", mean_line = T)


soe.plot(SOE.data.2018, "Time", "Planktivore Landings GB", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, 
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Planktivore NEFMC managed species sea food GB", mean_line = T)
soe.plot(SOE.data.2018, "Time", "Benthivore Landings GB", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Benthivore NEFMC managed species sea food GB", mean_line = T)
soe.plot(SOE.data.2018, "Time", "Benthos Landings GB", stacked = "E",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Benthos NEFMC managed species sea food GB", mean_line = T)
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)

```

## Total landings (black) and total landings managed by NEFMC (red) in Gulf of Maine (A) and Georges Bank (B)
```{r managed_landings_NE ,  echo=F, message=FALSE, warning=FALSE , fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Total Landings GOM", stacked = "A",status = F,mean_line = T,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed landings GOM")
soe.plot(SOE.data.2018, "Time", "Total Landings GB", stacked = "B",status = F,mean_line = T,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed landings GB")
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)
```

## New England recreational seafood landings
```{r rec_catch_NE, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Recreational Seafood NE", stacked = NA, status = F, full.trend = T,
         scale.axis = 10^6,end.start = 2007)
soe.stacked.axis("Time",expression("Fish caught, 10"^6*" n"), outer = F)

```

## Commercial Fishery Revenue

### Revenue change in Gulf of Maine and Georges Banks shown through aggregated price and volume indicators.
```{r 'Rev_Price_Vol_GOM_GB', echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth'}
knitr::include_graphics(file.path(image.dir, 'Pr_Vol_GOM.png'))
knitr::include_graphics(file.path(image.dir, 'Pr_Vol_GB.png'))

```

### Revenue change in Gulf of Maine in terms of feeding guilds.
```{r 'price_vol_ind_GOM' , echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth'}
knitr::include_graphics(file.path(image.dir, 'GOM_PI.png'))
knitr::include_graphics(file.path(image.dir, 'GOM_VI.png'))
```

### Revenue change in Georges Bank in terms of feeding guilds.
```{r 'price_vol_ind_GB' , echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth'}
knitr::include_graphics(file.path(image.dir, 'GB_PI.png'))
knitr::include_graphics(file.path(image.dir, 'GB_VI.png'))
```

## Total revenue (black) and total revenue from landings managed by NEFMC (red) in Gulf of Maine (A) and Georges Bank (B)

```{r managed_revenue_NE , fig.cap="Total revenue by region and MAFMC managed species\\label{totcommrev}", echo=F, message=FALSE, warning=FALSE , fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Total Revenue GOM", stacked = "A",status = F,mean_line = T,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed revenue GOM")
soe.plot(SOE.data.2018, "Time", "Total Revenue GB", stacked = "B",status = F,mean_line = T,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007,
         y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed revenue GB")
soe.stacked.axis("Time",expression("Revenue, 10"^6*"USD"), outer = T)
```

## New England commercial fleet diversity
```{r fleet diversity NE, echo=F, message=FALSE, warning=FALSE, include=T, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","New England average fleet diversity", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007)
soe.stacked.axis('Year', 'Fleet diversity', outer = F,rel.y.text = 1.2, y.line = 3)
soe.plot(SOE.data.2018,"Time","New England fleet count", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007)
soe.stacked.axis('Year', 'Fleet count', outer = F,rel.y.text = 1.2, y.line = 3)
```

## New England revenue diversity

```{r revenue diversity NE, echo = F, message=F, include=T, warning=F, fig.width=7, fig.height=4, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, 'Time', "New England commercial species diversity",stacked = NA, 
         endshade = T, full.trend = F, status = F,end.start = 2007)
soe.stacked.axis("Year","Shannon Index", outer = F)
```

## New England recreational opportunities (A: Rec participation, B: Angler trips)
```{r recreation NE, echo=F, message=FALSE, warning=FALSE, include=T, fig.width=8, fig.height=6, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","North Atlantic Rec participation", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6, status = F,end.start = 2007)
soe.plot(SOE.data.2018,"Time","North Atlantic angler trips", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6, status = F,end.start = 2007)
soe.stacked.axis('Year', expression('Recreational Participation, 10'^6*'n'))
```

## HAB Maps here

##Community social vulnerability, engagement and dependence on commercial fisheries

```{r 'commercial_reliance_and_vulnerability NE', echo=FALSE, fig.align="center", fig.cap="Commercial reliance and social vulnerability (NE) \\label{commvulmap}", fig.height=6, fig.width=6, message=F, warning=F, include=T}

if(map_figs){

cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability NE",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "commercial reliance NE",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)
lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude NE",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude NE",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                      lat = lat,
                      cat3 = cat3)

#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)


#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(usa, xlim = c(-72,-68.5), ylim = c(40.5,45.5),col = "grey")
plot(can, col = "grey", add = T)
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)

#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -68.5, xmx = -66.4, ymn = 41, ymx = 42.5, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)

#text
text(-68.8, 41.8, "Commercial Reliance",srt=90, cex = .85)
text(-67.5,40.8, "Social Vulnerability", cex = .85)
}
```

```{r 'recreational_reliance_and_vulnerability NE', echo=FALSE, fig.align="center", fig.cap="Commercial reliance and social vulnerability (NE) \\label{recvulmap}", fig.height=6, fig.width=6, message=F, warning=F,include = T}

if(map_figs){

cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability NE",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "recreational reliance NE",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)
lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude NE",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude NE",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                      lat = lat,
                      cat3 = cat3)

#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)


#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(usa, xlim = c(-72,-68.5), ylim = c(40.5,45.5),col = "grey")
plot(can, col = "grey", add = T)
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)

#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -68.5, xmx = -66.4, ymn = 41, ymx = 42.5, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)

#text
text(-68.8, 41.8, "Recreational Reliance",srt=90, cex = .85)
text(-67.5,40.8, "Social Vulnerability", cex = .85)
}
```




# Resource Species

## Trends in Biomass

## Fall Survey Biomass (GOM) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r fall_survey_GOM, echo = F, warning = F, include = T,out.width='1\\linewidth',fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Fall Biomass Index GOM", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.plot(SOE.data.2018, "Time", "Planktivore Fall Biomass Index GOM", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.plot(SOE.data.2018, "Time", "Benthivore Fall Biomass Index GOM", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007,
         y.min = F,y.lower = -15)

soe.plot(SOE.data.2018, "Time", "Benthos Fall Biomass Index GOM", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```


## Spring Survey Biomass (GOM) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r Spring_survey_GOM, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Spring Biomass Index GOM", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Planktivore Spring Biomass Index GOM", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Benthivore Spring Biomass Index GOM", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Benthos Spring Biomass Index GOM", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```


## Fall Survey Biomass (GB) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r fall_survey_GB, echo = F, warning = F, include = T,out.width='1\\linewidth',fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Fall Biomass Index GB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.plot(SOE.data.2018, "Time", "Planktivore Fall Biomass Index GB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.plot(SOE.data.2018, "Time", "Benthivore Fall Biomass Index GB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.plot(SOE.data.2018, "Time", "Benthos Fall Biomass Index GB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```


## Spring Survey Biomass (GB) (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)

```{r Spring_survey_GB, echo = F, warning = F, include = T,out.width='1\\linewidth', fig.width = 6,fig.height=7.5, fig.align='center'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Spring Biomass Index GB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Planktivore Spring Biomass Index GB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Benthivore Spring Biomass Index GB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.plot(SOE.data.2018, "Time", "Benthos Spring Biomass Index GB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)
```







<!-- ## Ecosystem-wide and managed species total landings -->

<!-- ```{r managed_landings ,  echo=F, message=FALSE, warning=FALSE , fig.width=7, fig.height=4, fig.align = 'center'} -->
<!-- opar <- par(mar = c(4, 6, 2, 6)) -->
<!-- # managed_land <- SOE.data.2018 %>% filter(Var == "Total managed landings MAB",Time >= 1986) -->
<!-- # total_land <-  SOE.data.2018 %>% filter(Var == "Total Landings MAB",Time >= 1986) -->
<!-- #  -->
<!-- # plot(total_land$Time, total_land$Value, col = "black", type = "o",ylab = "",xlab = "Time", -->
<!-- #                        lwd = 3, pch = 16,cex.lab=1.5, las = 1, cex.axis = 1.5, -->
<!-- #      bty = "l",ylim = c(4e4,28e4),yaxt = "n") -->
<!-- #  -->
<!-- # points(managed_land$Time, managed_land$Value, col = "indianred", type = "o", -->
<!-- #                        lwd = 3, pch = 16) -->
<!-- #  -->
<!-- # mtext(2, text = expression("Landings, 10"^3*'metric tons'), -->
<!-- #         line = 3.5, cex = 1.5, outer = F) -->
<!-- #   axis(2, at = seq(5e4,25e4,5e4),  -->
<!-- #        labels = c("50","100","150","200","250"), -->
<!-- #        las = 1, cex.axis = 1.5) -->
<!-- #  -->
<!-- # legend(1985,9e4,c("Ecosystem-wide","Managed species"), -->
<!-- #        col = c("black","indianred"),bty = "n", lwd = 3) -->

<!-- soe.plot(SOE.data.2018, "Time", "Total Landings NE", stacked = NA,status = F, -->
<!--          endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986, -->
<!--          y.min = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", y.var2 = "Total managed landings NE") -->
<!-- soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = F) -->
<!-- ``` -->
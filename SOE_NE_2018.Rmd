---
title: "State of the Ecosystem - Gulf of Maine and Georges Bank"
author: "Northeast Fisheries Science Center"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
graphics: yes
output:
  pdf_document:
    toc: no
    fig_caption: true
  html_document:
    toc: yes
  word_document:
    toc: no
fontsize: 11pt
header-includes: 
- \usepackage{float}
geometry: margin=1cm
self_contained: yes

---

```{r Directory and Data Set-up, echo=F, message=F, warning=FALSE, paged.print=TRUE}
#data.dir  <- '/home/slucey/EcoAP/SOE/2018'
#image.dir <- '/home/slucey/EcoAP/SOE/2018/images'
#data.dir <- 'Z:\\SOE2017\\data'
#image.dir <- 'Z:\\SOE2017\\images'
#data.dir  <- "F:/SOE/SOE_data"
#image.dir <- "F:/SOE/SOE_data"
#gis.dir <- 'F:/soe/soe_data/usa_shape_files'
data.dir  <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018'
image.dir <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018/images'
gis.dir <- '/users/sgaichas/Documents/0_Data/ESR/SOE2018/usa_shape_files'

#STOP HERE
#Do you have the most updated version of the SOE.data.2018 dataset AND the necessary spatial data? Check the SOE_MAB google drive for most recent version.


load(file.path(data.dir, "SOE_data_2018.Rdata"))
# latex figure folder
knitr::opts_chunk$set(echo = FALSE, fig.path = './iea_figs_ne/')

#The map_figs option can be set to FALSE to skip making maps on the fly (they will be missing). Or TRUE to make them. 
map_figs <- T

```

```{r libraries, echo=F, message=F, warning=FALSE, paged.print=TRUE, results = 'hide'}
library(Kendall);library(data.table);library(zoo)
library(dplyr);library(nlme);library(AICcmodavg)
library(colorRamps);library(Hmisc);library(rgdal)
library(maps);library(mapdata);library(raster)
library(grid);library(stringr);library(png)
library(ncdf4);library(marmap); library(magick); 
library(knitr)



#get map data and set constants
#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#coastline and bathymetry
coast <- readOGR(gis.dir, 'NES_LME_coast', verbose = F)
coast <- spTransform(coast,map.crs)
bathy <- raster('NES_bathymetry.tif')

#define extents for cropping
e  <- extent(-77.2, -64.2, 35, 48)
th_extent <-extent(-77,-65,35,45) #thermal habitat

#crop - thermal habitat bathymetry before general bathymetry
coast <- crop(coast, e)
th <- crop(bathy,th_extent)
bathy <- crop(bathy, e)

#projections
projection(th) <- map.crs
projection(bathy) <- map.crs

#get strata files to clip thermal habitat projections
strata <- readOGR(gis.dir,"strata", verbose = F)
strata@proj4string <- map.crs
```

```{r libraries and functions, include=F, echo = F}
options(repos = c(CRAN = "http://cran.rstudio.com"))


fit_lm <- function(dat) {
  # Remove missing values first so that all models
  # use the same number of observations (important for AIC)
  # dat <- dat %>% dplyr::filter(complete.cases(.))
  
  # Constant model (null model used to calculate 
  # overall p-value)
  constant_norm <-
    nlme::gls(series ~ 1, 
              data = dat)
  
  constant_ar1 <-
    try(nlme::gls(series ~ 1,
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(constant_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA)) 
  } 
  
  
  
  # Linear model with normal error
  linear_norm <- 
    nlme::gls(series ~ time, 
              data = dat)
  
  # Linear model with AR1 error
  linear_ar1 <- 
    try(nlme::gls(series ~ time, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(linear_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Polynomial model with normal error
  dat$time2 <- dat$time^2
  poly_norm <- 
    nlme::gls(series ~ time + time2, 
              data = dat)
  
  # Polynomial model with AR1 error
  poly_ar1 <- 
    try(nlme::gls(series ~ time + time2, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(poly_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Calculate AICs for all models
  df_aicc <-
    data.frame(model = c("poly_norm",
                         "poly_ar1",
                         "linear_norm",
                         "linear_ar1"),
               aicc  = c(AICc(poly_norm),
                         AICc(poly_ar1),
                         AICc(linear_norm),
                         AICc(linear_ar1)),
               coefs = rbind(coef(poly_norm),
                             coef(poly_ar1),
                             c(coef(linear_norm), NA),
                             c(coef(linear_ar1),  NA)),
               # Calculate overall signifiance (need to use
               # ML not REML for this)
               pval = c(anova(update(constant_norm, method = "ML"),
                              update(poly_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(poly_ar1, method = "ML"))$`p-value`[2],
                        anova(update(constant_norm, method = "ML"),
                              update(linear_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(linear_ar1, method = "ML"))$`p-value`[2]))
  
  best_lm <-
    df_aicc %>%
    dplyr::filter(aicc == min(aicc))
  
  
  if (best_lm$model == "poly_norm") {
    model <- poly_norm
  } else if (best_lm$model == "poly_ar1") {
    model <- poly_ar1
  } else if (best_lm$model == "linear_norm") {
    model <- linear_norm
  } else if (best_lm$model == "linear_ar1") {
    model <- linear_ar1
  }
  
  return(list(p = best_lm$pval,
              model = model))
}


#Plot new figure - Set end.start to 10 years before end of time series

soe.plot <- function(data, x.var, y.var, x.label = '', y.label = '', tol = 0.1,
                     x.start = NA, x.end = NA, end.start = 2008, bg.col = background, mean_line = T,
                     end.col = recent, stacked = NA, x.line = 2.5, y.line = 3.5, scale.axis = 1,
                     rel.y.num = 1.5, rel.y.text = 1.5, suppressAxis = FALSE,status  = F,anomaly = F,
                     endshade = TRUE, full.trend = TRUE, point.cex = 1.5, lwd = 2, ymax = TRUE,ymin = TRUE,
                     y.upper = y.upper, y.lower = y.lower, extra = FALSE, x.var2 = x.var2, y.var2 = y.var2,
                     line.forward = FALSE, mean_line.2 = T, cex.stacked = 1) {
  
  #print("You'll need to remove or interpolate NA values before this function will work")
  
  #Select Data
  x <- data[Var == y.var, ]
  x <- x[order(x[, get(x.var)]), ]
  setnames(x, x.var, 'X')
  
  #Set common time step if necessary
  if(is.na(x.start)) x.start <- min(x[, X])
  if(is.na(x.end))   x.end   <- max(x[, X])
  x <- x[X >= x.start, ]
  
  #Set up plot parameters
  if (ymax == TRUE){
    y.max <- max(x[, Value]) + tol * max(x[, Value])
  } else {
    y.max <- as.numeric(y.upper)
  }
  
  if (ymin == TRUE){
    y.min <- min(x[, Value]) - tol * abs(min(x[, Value]))
  } else if (ymin == FALSE){
    y.min <- as.numeric(y.lower)
  }
  
  y.mean <- mean(x[, Value])
  y.sd <- sd(x[, Value])
  
  #Plot blank plot
  plot(x[X >= x.start, list(X, Var)], xlim = c(x.start, x.end),
       ylim = c(y.min,y.max), xlab = '', ylab = '', axes = F, ty = 'n')


  #Add background
  u <- par('usr')
  rect(u[1], u[3], u[2], u[4], border = NA, col = bg.col)
  
  #Add end period shading
  if (endshade == TRUE){
    rect(end.start - 0.5, u[3], u[2], u[4], border = NA, col = end.col)
  }
  
  #Add mean line
  if (anomaly == F){
      if (mean_line == TRUE){
      abline(h = y.mean, col = 'grey', lwd = 3, lty = 2)
      } 
  } else if (anomaly == TRUE){
      abline(h = 0, col = 'grey', lwd = 3, lty = 2)
  }
  
  #Add x y lines
  abline(h = u[3], lwd=3)
  abline(v = u[1], lwd=3)
  
  #Add data points/lines
  points(x[, list(X, Value)], pch = 16, cex = point.cex)
  lines( x[, list(X, Value)], lwd = lwd)
  
  #extra lines
  if (extra == TRUE){
    x2 <- data[Var == y.var2, ]
    x2 <- x2[order(x2[, get(x.var2)]), ]
    setnames(x2, x.var2, 'X2')
    x2 <- x2[X2 >= x.start, ]
    if (mean_line.2 == TRUE){
     abline(h = mean(x2[, Value]), col = 'lightcoral', lwd = 3, lty = 2) 
    }
    points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
    lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
    }
    
  
  #Add axis
  if (suppressAxis == FALSE){
    if(is.na(stacked)) axis(1, cex.axis = 1)
    if(!is.na(stacked)){
      if(stacked!= 'A') axis(3, cex.axis = 1.5, tck = 0.1, labels = F)
    }
  }

  #Stacked axes with 0 overlap so need to remove
  labels <- round((axTicks(2) / scale.axis), 5)
  if(labels[1] == 0) labels[1] <- ''
  axis(2, at = axTicks(2), labels = labels, cex.axis = rel.y.num,
       las = T)

    #Add axis labels
    if(!is.na(stacked)) text(u[1], u[4], labels = stacked, cex = cex.stacked, adj = c(-0.5, 1.5))
    if(is.na(stacked)){
      mtext(1, text = x.label, line = x.line, cex = 1)
      mtext(2, text = y.label, line = y.line, cex = rel.y.text)
    }
  
    if (full.trend == T){
    #Split data into past decade and full time series
    dat <- as.data.frame(x[, list(X, Value)])
    
    dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
    # Fit linear model
    lm_out <- fit_lm(dat = dat)
    p <- lm_out$p
    if (p < .05){
        
      newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
      newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
      lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

      year <- seq(x$X[1],x$X[length(x$X)],length.out = length(dat$time))

      # Make plot
      if (lm_pred$fit[length(lm_pred$fit)] > lm_pred$fit[1]){
        lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)

        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
      } else if (lm_pred$fit[length(lm_pred$fit)] < lm_pred$fit[1]){
        lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        }
      }
    }
    
    if (extra == TRUE){
      
      # Second variable
      dat <- as.data.frame(x2[, list(X2, Value)])
    
      dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
     # Fit linear model
      lm_out <- fit_lm(dat = dat)
      p <- lm_out$p
      points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
      lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
      if (p < .05){
    
        newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
        newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
        lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)

        year <- seq(x2$X2[1],x2$X2[length(x2$X2)],length.out =length(dat$time))
   
    # Make plot
        if (lm_pred$fit[length(lm_pred$fit)] > lm_pred$fit[1] ){
          lines(year, lm_pred$fit, col = main.pos, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else if (lm_pred$fit[length(lm_pred$fit)] < lm_pred$fit[1]){
          lines(year, lm_pred$fit, col = main.neg, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } 
     }
    }

  }


 
}  


#Add axis labels for stacked plots
soe.stacked.axis <- function(x.label, y.label, x.line = 2.5,rel.x.text = 1.5,
                             y.line = 3.5, rel.y.text = 1.5, outer = TRUE){
  axis(1, cex.axis = rel.x.text)
  mtext(1, text = x.label, line = x.line, cex = rel.x.text, outer = outer)
  mtext(2, text = y.label, line = y.line, cex = rel.y.text, outer = outer)
  
}


#Background colors
background   <- 'white'
recent       <- '#E6E6E6'
main.pos <- rgb(253/255, 184/255, 99/255,  alpha = .9)
main.neg <- rgb(178/255, 171/255, 210/255, alpha = .9)

#Finder function for quickly finding variables based on partial match
finder <- function(data, match = match, factor = T){
  found <- unique(data[grepl(match,data$Var),]$Var)
  if (factor == T){
    return(found)
  } else {
    return(as.character(found))
  }
  
}

#thermal habitat map function
th_plot <- function(data, letter, z.max, y.axis = T,
                    legend = T, pos){
  if (pos == 'topleft'){
    par(mar=c(3.9, 2.8,3.5,0), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == 'topright'){
    par(mar=c(3.9, 0, 3.5, 2.8), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == "bottomleft"){
    par(mar=c(3.9,2.8,3.5,0), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == "bottomright"){
    par(mar=c(3.9, 0, 3.5, 2.8), mex = .3,  mgp = c(4, .35, 0))
  }
  
  data <- nc_open(data)
  
  #longitude
  lon <- ncvar_get(data, "xi", verbose = F)
  
  #latitude
  lat <- ncvar_get(data, "yi", verbose = F)
  
  #thermal habitat projection
  z <- ncvar_get(data, "zi")
  
  #combine in data.frame
  proj <- data.frame(lon = lon,
                     lat = lat,
                     z = z)
  
  proj <- proj %>% filter(z != "NA",z>0) %>% 
    mutate(z = plyr::mapvalues(z, from = (z[(z>z.max)]), to = rep(z.max,length(z[(z>z.max)]))))
  
  #turn dataframe to raster
  coordinates(proj) = ~lon+lat
  proj4string(proj)=map.crs # set it to lat-long
  proj = spTransform(proj,map.crs)
  proj <- proj[strata,]
  gridded(proj) = TRUE
  r = raster(proj)
  projection(r) = map.crs
  
  colors <- matlab.like(120)
  #plot maps
  if (legend == T){
      plot(r, col=colors, ylim=c(35,45),
       breaks=seq(0,z.max,length.out=length(colors)),
       zlim = c(0,z.max),
       legend.width = 2,
       axes=F, interpolate = T, las = 1,box = T,
       axis.args=list(at=seq(0, z.max, length.out = 5),
                      labels=round(seq(0,z.max,length.out = 5),1), 
                      cex.axis=0.8),
       legend.args=list(text=expression(paste("     Thermal \n      Habitat")),
                        side=3, font=2, line=1, cex=.65))
  } else {
       plot(r, col=colors, ylim=c(35,45),
       breaks=seq(0,z.max,length.out=length(colors)),
       axes=F, interpolate = F, las = 1,box = T,legend = F)
  }

  
  map("worldHires", xlim=c(-77,-65),ylim=c(35,45), fill=T,border=0,col="gray", add = T)
  
  if (y.axis == T){
    map.axes(cex.axis = .7)
  } else if (y.axis == F){
    axis(1,cex = .7)
    box(lty = 'solid', col = 'black',lwd = 1)
  }
  
  
  contour(th,drawlabels = F,nlevels = 2,add=T, col = "gray20",lty=2, lwd = .5)
  text(-75.5, 43.9, letter,cex = 1.5)

}


```

#Introduction

The purpose of this report is to provide **ecosystem-scale information for fishery managers** to consider along with existing species-scale analyses.  An overview of ecosystem relationships as represented by **a conceptual model helps place more detailed species-level management in context** by highlighting relationships between focal species groups organized by New England Fishery Management Council (NEFMC) Fishery Management Plan (FMP), managed human activities, environmental drivers, habitats, and key ecological links (Fig. \ref{conceptual}). Here, human activities link to high level strategic management objectives. Many components of the conceptual model are represented by indicators in this report, and key paths connecting components and objectives are highlighted.

```{r, fig.cap="Gulf of Maine and Georges Bank Ecosystem \\label{conceptual}", fig.height=6, fig.width=4, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
knitr::include_graphics(file.path(image.dir, 'ne_conceptual_model.pdf'))

```

\clearpage

# Executive Summary

We have organized this report using a proposed set of **ecosystem-scale objectives** derived from US legislation and current management practices (Table 1). We take a place-based approach and report indicators separately where possible and relevant for the two ecosystems under New England Council management: Georges Bank (GB) and Gulf of Maine (GOM; Fig. \ref{map}).

**Table 1**: New England ecosystem objectives
```{r obj_cats_NE, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Objective Categories     | Indicators reported here                                  |
|:-------------------------|:----------------------------------------------------------|
| Seafood production       | Landings by feeding guild                                 |
| Profits                  | Revenue by feeding guild                                  |
| Recreation               | Number of anglers and trips; recreational catch           |
| Stability                | Diversity indices (fishery and species)                   |
| Social-Cultural          | Commercial and recreational reliance; social vulnerability|
| Biomass                  | Biomass or abundance by feeding guild from surveys        |
| Productivity             | Condition and recruitment of NEFMC managed species        |
| Trophic structure        | Relative biomass of feeding guilds, primary productivity  |
| Habitat                  | Thermal habitat projections, estimated habitat occurrence |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```


```{r, fig.cap="Gulf of Maine (GOM) and Georges Bank (GB) spatial extent \\label{map}", fig.height=6, fig.width=4, out.width='0.9\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
image_read(file.path(image.dir,"NEshelfEcoRegionsALL.png")) %>%
image_trim()

```

**We also report single-species status relative to established objectives and reference points**. The New England Council (NEFMC) is meeting objectives at the managed species level for fishing mortality (F) rates for XX of YY stocks and biomass (B) levels for ZZ of YY stocks relative to established reference points (Fig. \ref{KOBE}). The exceptions include high F rates for XXX, likely high F rates for YYYYY, and likely low B status for ZZZZZ.

```{r, fig.cap="Summary of single species status for NEFMC stocks \\label{KOBE}", fig.height=7, fig.width=7, out.width='0.65\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
#knitr::include_graphics(file.path(image.dir, 'MAFMC_joint_stocks_2017.pdf'))

dat <- read.csv("2017assess.csv")

stocks <- unique(dat$Entity.Name)
n.stocks <- length(stocks)

decoder <- read.csv(file.path(data.dir,"2017decoder.csv"))
# set up the headers for most.recent structure - will contain oldest Assessment.Year
most.recent <- dat[1,]
most.recent <- most.recent[-1,]

for (i in 1:n.stocks){
  temp <- dat[dat$Entity.Name == decoder$Entity.Name[i],]
  most.recent <- rbind(most.recent,temp[temp$Assessment.Year == max(temp$Assessment.Year),])
}
#cbind(n.stocks,length(most.recent[,1]))

# get the max of F.Flimit and F.Fmsy and the max of B.Blimit and B.Bmsy
Frat <- most.recent$F.Fmsy
Brat <- most.recent$B.Bmsy
#Frat[6] <- most.recent$F.Flimit[6]  # Ocean Quahog use Flimit because no Fmsy
#Frat[18] <- 0.88  # hardwire average of the two GOM models for GOM cod
#Brat[18] <- 0.155 # hardwire average of the two GOM models for GOM cod
#model averages have been calculated and included in F/Fmsy column in 2017assess.csv
#cbind(most.recent$Entity.Name,most.recent$F.Flimit,most.recent$F.Fmsy)

# figure out appropriate range for axes WARNING HARD CODED
#max(Frat,na.rm=T)
#max(Brat,na.rm=T)
x.r <- c(0,4)
y.r <- c(0,3)

# set some colors
my.col <- rep(NA,n.stocks)
MA.col <- "blue"
NE.col <- "blue"
BO.col <- "purple"
for (i in 1:n.stocks){
  if(decoder$Council[i] == "MAFMC") my.col[i] <- MA.col
  if(decoder$Council[i] == "NEFMC") my.col[i] <- NE.col
  if(decoder$Council[i] == "Both")  my.col[i] <- BO.col
}

# create new matrix for plotting
xx <- as.data.frame(cbind(decoder[,2:8],Frat,Brat,my.col))
newlist <- as.factor(decoder$Code)
others <- as.factor("7 Skates")
sppcodes <- unlist(list(newlist, others))
MA.unknown <- sppcodes[c(1,3,4,47,48)] #mackerel, Loligo, Illex, monkfish unknown
#MA.unknown <- decoder$Code[c(1,3,4,8)] #BSB known
#NE.unknown <- c(decoder$Code[c(14,23,33)],"7 Skates")
NE.overfished <- sppcodes[c(17,19)] # GB cod, halibut
NE.unknown <- sppcodes[c(14,23,33,35,37,47,48,50)] #Red deepsea crab,  Offshore hake, GOM winter flounder, Witch flounder, GB YT,2 monkfish, 7 skates unknown


# break out the Councils
MA <- xx[xx$Council == "MAFMC",]
NE <- xx[xx$Council == "NEFMC",]
BO <- xx[xx$Council == "Both",]
MABO<-rbind(MA, BO)
NEBO<-rbind(NE, BO)

#if(saveplots) png(file = "MAFMC_joint_stocks_2017.png",  units="in", width = 6, height = 6, res=1200)
# plot(MABO$Brat,MABO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[c(1:11,47:49)])
#   abline(v=0.5,lty=2)
#   abline(v=1,lty=3)
#   abline(h=1,lty=2)
#   title(expression("MAFMC " * phantom("and Joint Stocks")), col.main="blue")
#   title(expression(phantom("MAFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
#   title(expression(phantom("MAFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
#   title(expression(phantom("MAFMC and Joint") * " Stocks"), col.main="black")  
#   legend('topright',legend=MA.unknown,pch=NA,text.col=my.col[c(1,3,4,47,48)], title="Unknown Status", title.col = "black")
#   text(MABO$Brat,MABO$Frat,labels=MABO$Code,pos=MABO$my.pos3,col=my.col[c(1:11,47:49)],cex=0.8)
#if(saveplots) savePlot("MAFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

#if(saveplots) pdf(file = "NEFMC_joint_stocks.pdf",  width = 6, height = 6)
#if(saveplots) png(file = "NEFMC_joint_stocks.png",  units="in", width = 6, height = 9, res=1200)
plot(NEBO$Brat,NEBO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[12:49])
   abline(v=0.5,lty=2)
   abline(v=1,lty=3)
   abline(h=1,lty=2)
   title(expression("NEFMC " * phantom("and Joint Stocks")), col.main="blue")
   title(expression(phantom("NEFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
   title(expression(phantom("NEFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
   title(expression(phantom("NEFMC and Joint") * " Stocks"), col.main="black")
   legend('topright',legend=NE.overfished,pch=NA,title="Overfished, F \nStatus Unknown",bty="n", text.width=strwidth("Offshore Hake"), inset=c(0,.05))
   legend(3,2.5,legend=NE.unknown,pch=NA,title="Unknown Status", bty="n")
   text(NEBO$Brat,NEBO$Frat,labels=NEBO$Code,pos=NEBO$my.pos3,col=my.col[12:49],cex=0.8)
#if(saveplots) savePlot("NEFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

```

**Performance against human dimensions objectives is mixed, with declines in seafood production, recreational opportunities, and revenue diversity**. Benthivores have driven recent revenue volatility in both GOM and GB. On GB, this coincides with a flip from benthivore to benthos dominated revenue stream, along with a decline in seafood production. In GOM, total seafood production has been relatively stable. Recreational participation and commercial fleet diversity in NE has seen a continuing decline, and commercial species diversity at the permit level is near an all-time low. Overall, the increasing dominance of benthos could indicate issues in diversity and resilience of the biological system. **Low diversity and reduced resilience threatens high-value port communities like New Bedford, the port with the highest valued landings in the US, primarily composed of climate-vulnerable benthos**. 

**Fisheries are currently meeting objectives with respect to protected species bycatch reduction, but climate and ecosystem changes may upset this balance**. Fisheries interactions with harbor porpoise have decreased due to management measures, but climate driven distribution changes for sea turtles may lead to future fishery interactions and potential regulations. In addition, the most endangered species in the system (North Atlantic right whale) may be declining over the most recent few years after a slow but steady increase. **Ecosystem conditions combined with changing distributions may be contributing to the decline and observed unusual mortality event for right whales in 2017**.

Survey biomass trends for aggregated trophic groups are similar across spring and fall and between the Gulf of Maine and Georges Bank. At the lowest trophic level, both **forage fish and benthos, including commercial shellfish, show long term biomass increases** in both seasons. Both **benthivores and piscivores at higher trophic levels have stable or increasing trends** depending on the season sampled, in particular during the most recent decade. However, these **biomass increases are largely driven by non-commercial species**. Species diversity has increased in the Gulf of Maine, but remained stable or decreased on Georges Bank depending on the season sampled.

**Additional indicators in this report suggest a note of caution for the aggregate productivity of fish species in the region** (fish condition declined and recovered for some species). These changes in fish productivity may be linked to observed patterns in plankton communities, to changes in habitat, or both.  While there are few clear long-term trends at the bottom of the food web in New England, changes in species composition and shifts in seasonal timing may have a greater impact on upper trophic levels. Temperature is increasing in long term sea surface records as well as surface and bottom measurements from surveys. The seasonal temperature signal also shows sustained warming. **Warming waters have impacts on the ecosystem that can be complex due to differential impacts at the species level, including observed shifts in species distribution and changes in productivity as thermal habitats shift.** 

# Changes for 2018

Indicators throughout the report have been updated with the most recent data, and in some cases replaced with more management-relevant indicators based on Council feedback from the 2017 report. In particular, new sections on species-specific habitat status and trends and climate projections of thermal habitat for key species have replaced last year’s more general physical environment and climate sections. This report draws on a wider range of expertise and attempts to further link information across indicators to give an integrated overview of ecosystem status relevant to fishery management decision making.

Many metrics aggregate species by similar functional groups.  Species that comprise the functional groups are listed below. Relative to the 2017 report, these categories have been aggregated into fewer groups for simplification and clarity (Table 2).

**Table 2**: New England feeding guilds.
```{r species_groupings_NE, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Group             | N species | Major species in the group       |
|:------------------|:-------|:--------------------------------------------|
| A: **Apex predator** (Highest trophic level)   |  4  | shark (Unc.), swordfish, yellowfin and bluefin tuna |
| B: **Piscivore** (Eat fish)                    |  23 | monkfish, winter and thorny skates, silver and offshore hake, Atlantic cod, halibut, fourspot flounder, spiny dogfish, summer flounder, bluefish, striped bass, weakfish|
| C: **Planktivore** (Eat plankton)              |  16 |  Atlantic herring, butterfish, Atlantic mackerel, menhaden, river herrings, shad, white hake, longfin and shortfin squids, searobins, sculpin, lumpfish |
| E: **Benthivores** (Eat bottom dwellers)       |  25 | lobster, haddock, yellowtail, winter, and witch flounders, barndoor skate, ocean pout, black sea bass, scup, tilefish, tautog, cunner, blue crab, red crab, other crabs |
| F: **Benthos**  (Filter feeders)               |  9  |   scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars and urchins |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

Our assessment of indicator trends has changed this year.  In the 2017 time series plots, monotonic (but not necessarily linear) trends were assessed for both the full time series and the most recent 10 years (shaded dark grey background). Recent simulation analysis suggest that statistical significance tests are unreliable for short time series, but reliable for longer ones. Therefore, similar to 2017, we indicate significant increasing long term trends with orange lines, while significant decreasing long term trends have purple lines.  However, we no longer indicate significant trends for the most recent period but rather discuss recent/current status and trend of each indicator relative to the full time series.  Time series mean is indicated with a dashed line and the final ten years of the time series are highlighted through a grey background. 

\clearpage

# Human Dimensions 

## Seafood production 
Seafood production is a stated goal of optimal fishery management as part of the definition of “benefits to the nation” under MSA. Both commercial and recreational fishing contributes to seafood production, the latter for personal consumption, and indicators for each of these human activities track management performance against this objective.  

Commercial landings include all seafood landings in the region, including species not managed by NEFMC. For example, category D, Benthivores, includes lobsters, which are a substantial portion of the landings and drive increases in landings and revenue. In 2016, NEFSC managed stocks made up from 5%-98% of total landings by category, as detailed below (Table 3). 

```{r prop_table_NE,echo = F, results = 'asis', fig.width=5, fig.align = 'center'}
#Use this to create table of proportion of landings/revenue derived from NEFMC species (stargazer produces latex. Set eval = F)
#library(stargazer)
#convert to kable
gom_landings <- SOE.data.2018[grepl("GOM Landings 2016", SOE.data.2018$Var),]$Value
joint_gom_landings <- SOE.data.2018[grepl("GOM Joint Landings 2016", SOE.data.2018$Var),]$Value

gb_landings <- SOE.data.2018[grepl("GB Landings 2016", SOE.data.2018$Var),]$Value
joint_gb_landings <- SOE.data.2018[grepl("GB Joint Landings 2016", SOE.data.2018$Var),]$Value

gom_revenue <- SOE.data.2018[grepl("GOM Revenue 2016", SOE.data.2018$Var),]$Value
joint_gom_revenue <- SOE.data.2018[grepl("GOM Joint Revenue 2016", SOE.data.2018$Var),]$Value

gb_revenue <- SOE.data.2018[grepl("GB Revenue 2016", SOE.data.2018$Var),]$Value
joint_gb_revenue <- SOE.data.2018[grepl("GB Joint Revenue 2016", SOE.data.2018$Var),]$Value

 df <- data.frame(Groups = c("Piscivore","Planktivore","Benthivore","Benthos"),
                  gom_landings = gom_landings+joint_gom_landings,
                  gb_landings = gb_landings+joint_gb_landings,
                 
                  gom_revenue = gom_revenue + joint_gom_revenue,
                  gb_revenue = gb_revenue + joint_gb_revenue) 
                 

names(df) <- c("Groups", "GOM Landings", "GB Landings", "GOM Revenue",
                "GB Revenue")

kable(df, digits=2, caption = "Proportion managed by NEFMC")
#stargazer(df, summary = F, rownames = T, title = "Proportion of catch managed by NEFMC (2016)", header = F)
```

<!--**Table 3**: Proportion of landings and revenue derived from managed species in New England. 
```{r prop_landings_rev_MAB, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| Groups          | GOM Landings| GB Landings| GOM Revenue| GB Revenue|
|:----------------|:------------|:-----------|:-----------|:----------|
| Piscivore       | 0.98        | 0.98       | 0.93       | 0.91      | 
| Planktivore     | 0.89        | 0.90       | 0.89       | 0.77      | 
| Benthivore      | 0.05        | 0.42       | 0.03       | 0.26      |
| Benthos         | 0.30        | 0.30       | 0.71       | 0.85      |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```
-->

Figure \ref{landings} shows the removals for human consumption both at the entire EPU level as well as those removals managed by the NEFMC. Landings of piscivores have decreased over the long term in both systems. Benthos landings show no long term trends in either system. Other groups have a decreasing landings trend in either GOM or GB. 

```{r seafood_landings_GOM,  fig.cap = "Total landings (black) and total landings managed by NEFMC (red) in Gulf of Maine (left) and Georges Bank (right) (A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos).\\label{landings}", echo = F, fig.show='hold',fig.height = 5.5, fig.align='default',out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}

## Gulf of Maine cosystem-wide and managed species total landings
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time","Apex Predator Landings GOM", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Piscivore Landings GOM", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Piscivore NEFMC managed species sea food GOM", mean_line = T, cex.stacked = 2)


soe.plot(SOE.data.2018, "Time", "Planktivore Landings GOM", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 ="Planktivore NEFMC managed species sea food GOM", mean_line = T, cex.stacked = 2)
soe.plot(SOE.data.2018, "Time", "Benthivore Landings GOM", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Benthivore NEFMC managed species sea food GOM", mean_line = T, cex.stacked = 2)
soe.plot(SOE.data.2018, "Time", "Benthos Landings GOM", stacked = "E",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Benthos NEFMC managed species sea food GOM", mean_line = T, cex.stacked = 2)
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)

## Goerges Bank ecosystem-wide and managed species total landings
opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time","Apex Predator Landings GB", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Piscivore Landings GB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Piscivore NEFMC managed species sea food GB", mean_line = T, cex.stacked = 2)


soe.plot(SOE.data.2018, "Time", "Planktivore Landings GB", stacked = "C",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 ="Planktivore NEFMC managed species sea food GB", mean_line = T, cex.stacked = 2)
soe.plot(SOE.data.2018, "Time", "Benthivore Landings GB", stacked = "D",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Benthivore NEFMC managed species sea food GB", mean_line = T, cex.stacked = 2)
soe.plot(SOE.data.2018, "Time", "Benthos Landings GB", stacked = "E",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 = "Benthos NEFMC managed species sea food GB", mean_line = T, cex.stacked = 2)
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T)

```

Total commercial seafood landings from all species and from NEFMC managed species indicate total seafood production in the GOM and GB, which has declined over the long term. 

```{r managed_landings_NE , fig.cap = "Total landings (black) and total landings managed by NEFMC (red) in Gulf of Maine (A) and Georges Bank (B).", echo=F, message=FALSE, warning=FALSE , fig.asp=.5, fig.align = 'center'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Total Landings GOM", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 =  "Total managed landings GOM")
soe.plot(SOE.data.2018, "Time", "Total Landings GB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 =  "Total managed landings GB")
soe.stacked.axis("Time",expression("Landings, 10"^3*"metric tons"), outer = T, rel.x.text = 1.2, rel.y.text = 1.2)
```

Recreational seafood landings (as opposed to total landings which include catch and release that are captured under other risk elements/indicators) were used to assess food use of recreationally caught fish. This trend is also declining. 

```{r rec_catch_NE, fig.cap = "Recreational seafood landings in New England.",echo = F, message=F, include=T, warning=F,fig.asp = 0.45, fig.align = 'center',fig.pos='H'}
opar <- par(mar = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Recreational Seafood NE", stacked = NA, status = F, full.trend = T,
         scale.axis = 10^6,end.start = 2007, suppressAxis = T)
soe.stacked.axis("Time",expression("Fish caught, 10"^6*" n"), outer = F, rel.x.text = 1.2, rel.y.text = 1.2)

```

## Commercial Fishery Revenue

This indicator links the human activity of commercial fishing to the profits objective. The Bennet indicator is used to compare differences in revenue caused by changing quantities of landings and prices during the time period 1964-2016. Each year in the series is compared to an “average” year based on revenue during the entire period. Average revenue, landings and an implicit price (revenue/landings) is calculated for the time period. The volume indicator measures the contribution of changing quantities to revenue change and the price indicator measures the contribution of changing prices. The overall Bennet index is the sum of the volumen and price indicators in each year.

In the years between 1970 and 1990, Gulf of Maine revenue was generally below average (Fig. \ref{Bennet}A), and this was due to either lower volumes or lower prices depending on the year. After 1990, revenue was higher than average, before declining dramatically after 2000 mostly due to lower volumes. Revenue then fluctuated between 2008 and 2016, with some years being above average and some below. During most of these yearly cycles, changes in volume of Benthivores were responsible for the changes in overall volume (Fig. \ref{BennetGOM}A). Benthivores were also the group whose price difference was the primary reason for the changes in the overall price (Fig. \ref{BennetGOM}B).


```{r 'Rev_Price_Vol_GOM_GB',fig.cap = "Revenue change in Gulf of Maine (A) and Georges Banks (B) shown through aggregated price and volume indicators.\\label{Bennet}" , fig.width = 8,fig.height = 2.75, fig.show='hold',fig.pos='H'}
price_ind<-readPNG(file.path(image.dir, "Pr_Vol_GOM.png"))
vol_ind<-readPNG(file.path(image.dir, "Pr_Vol_GB.png"))

par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(1,2))
plot.new()

usr<-par("usr")

#fill plot with images
rasterImage(price_ind, usr[1], usr[3], usr[2], usr[4], interpolate=T)
rasterImage(vol_ind, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])

#Add text
text(.12,.825, "A", cex=1.5)
text(1.22,.825, "B", cex=1.5)

```

```{r 'price_ind_GOM',fig.cap="Gulf of Maine Bennet indicator, price component (A) and volume component (B) by functional group\\label{BennetGOM}." , fig.width = 8,fig.height = 2.75, fig.show='hold',fig.pos='H'}
price_ind<-readPNG(file.path(image.dir, "GOM_PI.png"))
vol_ind<-readPNG(file.path(image.dir, "GOM_VI.png"))

par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(1,2))
plot.new()

usr<-par("usr")

#fill plot with images
rasterImage(price_ind, usr[1], usr[3], usr[2], usr[4], interpolate=T)
rasterImage(vol_ind, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])

#Add text
text(.12,.825, "A", cex=1.5)
text(1.22,.825, "B", cex=1.5)
```

On Georges Bank, revenue showed a cyclical pattern which alternated between a positive and negative deviation from average revenue between 1964 and 2016 (Fig. \ref{Bennet}B) During periods of negative revenue growth, the decline was caused by lower volumes rather than lower prices. In most years, positive price growth helped offset any negative volume change. Before the 1980’s positive Benthivore and Planktivore volumes were offset by negative Benthos volumes (Fig. \ref{BennetGB}B). The 1990’s time period showed declining volumes of virtually all groups. Shortly after 2000, the Benthos group contributed positively to revenue, while the Benthivore group was a negative contributor, a reversal of the trend which existed prior to 1980.  The price indicator showed a different trend (Fig. \ref{BennetGB}A). Until the mid-1980’s the Benthos group prices contributed positively to revenue gains compared to the average. The price trend for the Benthos group then turned negative, while the Benthivore group contributed positively to the price indicator.

```{r 'price_ind_GB',fig.cap="Georges Bank Bennet indicator, price component (A) and volume component (B) by functional group\\label{BennetGB}." , fig.width = 8,fig.height = 2.75, fig.show='hold',fig.pos='H'}
price_ind<-readPNG(file.path(image.dir, "GB_PI.png"))
vol_ind<-readPNG(file.path(image.dir, "GB_VI.png"))

par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(1,2))
plot.new()

usr<-par("usr")

#fill plot with images
rasterImage(price_ind, usr[1], usr[3], usr[2], usr[4], interpolate=T)
rasterImage(vol_ind, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])

#Add text
text(.12,.825, "A", cex=1.5)
text(1.22,.825, "B", cex=1.5)
```

## Ecosystem-wide and Managed Species Total Revenue
Average total revenue from NEFMC managed species ranges from 3-93% of total revenue from commercial fishing in the region in 2016 (Fig. \ref{totcommrev}).

```{r managed_revenue_NE , fig.cap="Total revenue by region and NEFMC managed species\\label{totcommrev}.", echo=F, message=FALSE, warning=FALSE , fig.asp = 0.5, fig.align = 'center',fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, "Time", "Total Revenue GOM", stacked = "A",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 =  "Total managed revenue GOM", cex.stacked = 1.5)
soe.plot(SOE.data.2018, "Time", "Total Revenue GB", stacked = "B",status = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 10^6,end.start = 2007, x.start = 1964,
         ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
         y.var2 =  "Total managed revenue GB", cex.stacked = 1.5)
soe.stacked.axis("Time",expression("Revenue, 10"^6*"USD"), outer = T, rel.x.text = 1.2, rel.y.text = 1.2)
```

## New England commercial fleet diversity

Maintaining diversity can provide the capacity to adapt to change at the ecosystem level for dependent fishing communities, and can address objectives related to stability. Diversity estimates have been developed for fleets and species landed by vessels with New England species permits. A fleet is defined here as the combination of gear code (Scallop Dredge, Other Dredge, Gillnet, Hand Gear, Longline, Bottom Trawl, Midwater Trawl, Pot, Purse Seine, or Clam Dredge) and vessel length category (Less than 30 ft, 30 to 50 ft, 50 to 75 feet, 75 ft and above). The metric presented assesses the diversity of the overarching fleet, in terms of all revenue generated. This is coastwide rather than GOM or GB specific. 

The fleet revenue diversity for individuals landing NEFMC FMP species shows a consistent downward trend across the entire time series. A declining trend in diversity indicates reliance on either a smaller number of resources, or a less diverse pool of resources but cannot distinguish whether specialization (by choice), or alternatively stovepiping (constrained choices), is occurring in New England. A count of the number of fleets actively landing NEFMC FMP species in each year is relatively consistent with the revenue diversity metric, with a consistent downward trend throughout the time series.

```{r fleet diversity NE, fig.cap = "New England commercial fleet diversity (A) and fleet count (B).", echo=F, message=FALSE, warning=FALSE, include=T, fig.asp=0.5, fig.align = 'center',fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","New England average fleet diversity", stacked = "A",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007, cex.stacked = 1.5)
soe.stacked.axis('Year', 'Fleet diversity', outer = F,rel.y.text = 1.05,rel.x.text = 1.2, y.line = 3)
soe.plot(SOE.data.2018,"Time","New England fleet count", stacked = "B",
         endshade = T, rel.y.num = 1.1, full.trend = F, status = F,end.start = 2007, cex.stacked = 1.5)
soe.stacked.axis('Year', 'Fleet count', outer = F,rel.y.text = 1.05,rel.x.text = 1.2, y.line = 3)
```

## New England revenue diversity
Another diversity index is the average effective Shannon index for species revenue at the permit level, for all permits landing any amount of NEFMC FMP species within a year (including both Monkfish and Spiny Dogfish). Although the exact value of the effective Shannon index is relatively uninformative, the major change in diversity seems to have occurred in the late 1990’s, with much of the recent index relatively stable. 

```{r revenue diversity NE,fig.cap = "New England species revenue diversity.", echo = F, message=F, include=T, warning=F,  fig.asp=0.45, fig.align = 'center',fig.pos='H'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, 'Time', "New England commercial species diversity",stacked = NA, 
         endshade = T, full.trend = F, status = F,end.start = 2007, suppressAxis = T)
soe.stacked.axis("Year","Shannon Index", outer = F,rel.x.text = 1.2, rel.y.text = 1.2)
```

<!--This trend contrasts with the species diversity trends for the Gulf of Maine from survey data presented below, which indicate relatively low diversity during the mid-1990’s and higher diversity now (with a significantly increasing recent trend in both the fall and spring survey data). However, Georges Bank survey species diversity trends differ from Gulf of Maine in both seasons with less contrast between the mid-1990’s and the present. 

Ultimately, diversity can be measured in numerous ways (for example, in numbers of vessels in each fleet component as opposed to revenue) and feedback from the Council as to how this should be defined is welcomed.-->

## New England recreational opportunities
Providing recreational opportunities is a stated goal of optimal fishery management as part of the definition of “benefits to the nation” under MSA. Recreational fishing is important in the New England region, with many coastal communities from Cape Cod southward having high recreational dependence. Although there is a long-term trend of increasing recreational fishery participation in terms of number of anglers, the most recent 10 years has shown a striking decline in both recreation indices. 

```{r recreation NE,fig.cap = "Recreational participation (A) and number of angler trips (B) in New England.", echo=F, message=FALSE, warning=FALSE, include=T,  fig.asp=0.5, fig.align = 'center',fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time","North Atlantic Rec participation", stacked = "A",
         endshade = T, rel.y.num = 0.9, full.trend = T, scale.axis = 10^6, status = F,end.start = 2007, cex.stacked = 1.5)
soe.plot(SOE.data.2018,"Time","North Atlantic angler trips", stacked = "B",
         endshade = T, rel.y.num = 0.9, full.trend = T, scale.axis = 10^6, status = F,end.start = 2008, cex.stacked = 1.5)
soe.stacked.axis('Year', expression('Recreational Participation, 10'^6*'n'),rel.x.text = 1.2, rel.y.text = 1.2)
```


## Harmful Algal Blooms

The seasonal occurrence of harmful algal blooms (HABs) in New England is responsible for fluxes of saxitoxin and domoic acid into shellfish beds, which can result in paralytic shellfish poisoning (PSP) and amnesic shellfish poisoning (ASP) respectively. Blooms of *Alexandrium fundyense* cause regular closures of shellfish beds from Maine to Massachusetts due to saxitoxin contamination, with at least 30 PSP-related closures occurring between 2007-2016 (Fig. \ref{HAB}). Average blue mussel saxitoxin content in Maine waters increased from 2014 to 2017, although the change was driven by anomalously high values at 2 of 18 sampling sites in 2017. The prevalence of saxitoxin in Maine blue mussel beds exhibits high interannual variability with evidence suggesting a decadal cycle of toxicity.

Blooms of *Pseudo-nitzchia* species that produce domoic acid have become more common in the past decade. In fall 2016, *Pseudo-nitzchia* blooms caused closures of shellfish beds in Maine and Rhode Island. An unprecedented late-season *Pseudo-nitzchia* bloom resulted in the closure of shellfish harvesting in Casco Bay, ME in December 2017. Blooms of the dinoflagellate *Dinophysis* could also pose a threat to New England waters, with the first ever *Dinophysis* related waterway closure in Massachusetts occurring in 2015.

```{r NE_HAB, fig.cap="HAB-related shellfish bed closures in New England (2007-2016).\\label{HAB}", echo=F,message=FALSE, warning=FALSE ,fig.align='center', fig.asp=1.1,fig.width=6,fig.pos='H',strip.white=T}
#get map data
e1  <- extent(-78.5, -64, 41, 45)
coast1 <- crop(coast, e1)

events <- SOE.data.2018[grepl("SP occurrence",SOE.data.2018$Var),]

events_df <- data.frame(lon = events[grepl("Lon",events$Var),]$Value,
                        lat = events[grepl("Lat",events$Var),]$Value,
                        val = events[grepl("occurrence N",events$Var),]$Value,
                        var = word(events[grepl("occurrence N", events$Var),]$Var,1))

colors <- c("darkorange","purple","grey")
events_df <- events_df %>% 
  mutate(colors = plyr::mapvalues(var, from = c("DSP","ASP","PSP"),
                                                to = c(colors)))
colors <- events_df$colors

g1 <- events_df %>% filter(val == 8)
g2 <- events_df %>% filter(val == 3.5)
g3 <- events_df %>% filter(val == 1)

#data.frame to sp object
coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)

# coordinates(g2) <- ~lon+lat
# g2@proj4string <- map.crs
# g2 <- spTransform(g2, map.crs)

coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)


#plot map and dots of different size based on category
par(mar = c(0,2.8,0,0.2))
plot(coast1, xlim = c(-71.5,-64.5),ylim = c(41,45),col = "grey",yaxs="i")
plot(g1,  add = T,cex = 6, pch = 16, col = "darkorange")
#plot(g2,  add = T,cex = 4, pch = 16, col = "purple")
plot(g3,  add = T,cex = 2, pch = 16, col = c("purple","#56B4E9"))

axis(1, at = c(-71,-69,-67,-65), labels = paste( c(-71,-69,-67,-65) * -1, 'W'),col = NA, col.ticks = 1, pos = 41)
axis(2, at = c(45, 44, 43, 42, 41.05), labels = paste(c(45, 44, 43, 42, 41), 'N'), las = T, pos = -71.78,col = NA, col.ticks = 1)
legend(-66.2,42.5, c("PSP", "ASP", "DSP"), col = c("darkorange","purple","#56B4E9"), pch = 16,
       cex = 1.1, bty = "n", pt.cex = 2)
text(-65.65,42.495, "Category")
arrows(-71.765,41,-71.765,45,angle = 90,lwd = 2)
arrows(-64.22,41,-64.22,45,angle = 90,lwd = 2)
abline(h = 41, lwd = 2)
abline(h = 45, lwd = 2)
abline(v = -64, lwd = 2)
legend(-67.9,42.5, c("6-10", "2-5", "1"), col = c("black"), pch = 16, cex = 1.1,
       pt.cex = c(6,4,2), x.intersp = 1.45, y.intersp = 1.75, bty = "n")
text(-67.7,42.525, "2007-2016 Detections")

```

##Community social vulnerability, engagement and dependence on commercial fisheries

The NOAA Fisheries Community Social Vulnerability Indicators (CSVIs) are statistical measures of the vulnerability of communities to events such as regulatory changes to fisheries, wind farms, and other ocean-based businesses, as well as to natural hazards, disasters, and climate change. The CSVIs currently serve as indicators of social vulnerability, gentrification pressure vulnerability, commercial and recreational fishing reliance and engagement, sea level rise risk, species vulnerability to climate change, and catch composition diversity.
 
Here, we look at the extent to which commercial and recreational fishing reliance intersect with community social vulnerability in the New England region. Commercial fishing reliance is a measure of per capita pounds landed, value landed, commercial permits and commercial dealers in a community. Recreational reliance is a per capita measure of shore, private vessel and for-hire recreational fishing in a community. Social vulnerability represents social factors that can shape either an individual or community’s ability to adapt to change. There are many socially vulnerable communities in the New England region, but with varying degrees of commercial and/or recreational fishing reliance. While there are some communities that are both moderate to highly socially vulnerable and moderate to highly reliant on commercial fishing in Northern New England (Fig.\ref{commvulmap}), there are different communities in Southern New England that are both moderate to highly vulnerable and moderate to highly reliant on recreational fishing (Fig. \ref{commvulmap}).

\newpage

```{r 'commercial_reliance_and_vulnerability NE' , fig.cap="Commercial (A) and recreational (B) reliance and social vulnerability in New England \\label{commvulmap}",echo = F, message=F, include=T, warning=F, fig.show='hold', fig.width = 8,fig.height = 5.4,strip.white=T,fig.pos='H'}
par(mfrow=c(1,2), mar = c(2,2.85,1,1))
if(map_figs){

cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability NE",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "commercial reliance NE",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)
lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude NE",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude NE",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                      lat = lat,
                      cat3 = cat3)

#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)


#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(coast, xlim = c(-72,-68.1), ylim = c(40.5,45.5),col = "grey")

#plot(can, col = "grey", add = T)
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)

#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -69.2, xmx = -67.7, ymn = 41, ymx = 42.1, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)
axis(1, at = c(-72,-70,-68,-66), labels = paste( c(-72,-70,-68,-66) * -1, 'W'),pos = 40.29,col = NA, col.ticks = 1)
axis(2, at = axTicks(2), labels = paste(axTicks(2), 'N'), las = T, pos = -72.55,col = NA, col.ticks = 1)
box(lty = 1, lwd = 2)
#text
text(-69.475, 41.55, "Commercial Reliance",srt=90, cex = .75)
text(-68.4,40.8, "Social Vulnerability", cex = .75)
text(-72.25,45.5, "A", cex = 1.5)

######## recreational reliance ########
cat1 <- SOE.data.2018[SOE.data.2018$Var == "social vulnerability NE",]$Value
cat2 <- SOE.data.2018[SOE.data.2018$Var == "recreational reliance NE",]$Value

#group data into categories
ncat1 <- NULL
for (i in 1:length(cat1)){
  if (cat1[i] > 2){
    ncat1[i] <- "C"
  } else if ((cat1[i] <= 2) & (cat1[i] > 1)){
    ncat1[i] <- "B"
  } else {
    ncat1[i] <- "A"
  }
}

ncat2 <- NULL
for (i in 1:length(cat1)){
  if (cat2[i] > 2){
    ncat2[i] <- 3
  } else if ((cat2[i] <= 2) & (cat2[i] > 1)){
    ncat2[i] <- 2
  } else {
    ncat2[i] <- 1
  }
}


cat3 <- paste0(ncat1, ncat2)
cat3 <- factor(cat3, levels = c("A1","A2","A3",
                                "B1","B2","B3",
                                "C1","C2","C3"),
               ordered = TRUE)
lon <- SOE.data.2018[SOE.data.2018$Var == "choropleth longitude NE",]$Value
lat <- SOE.data.2018[SOE.data.2018$Var == "choropleth latitude NE",]$Value

#new dataframe to turn into sp object
mab.dat <- data.frame(lon = lon,
                      lat = lat,
                      cat3 = cat3)

#break up into groups for plotting - allows for effective layering
g1 <- mab.dat %>% filter(cat3 == "A1"|cat3 == "A2"|cat3 == "A3") %>% arrange(cat3)
g2 <- mab.dat %>% filter(cat3 == "B1"|cat3 == "B2") %>% arrange(cat3)
g3 <- mab.dat %>% filter(cat3 == "C1") %>% arrange(cat3)


g2_big <- mab.dat %>% filter(cat3 == "B3")
g3_big <- mab.dat %>% filter(cat3 == "C2"|cat3 == "C3") %>% arrange(cat3)


#turn grouped data into sp objects for overlaying on plot of Mid-Atlantic

coordinates(g1) <- ~lon+lat
g1@proj4string <- map.crs
g1 <- spTransform(g1, map.crs)
colo1 <- c(rep("#FFFFFF",table(g1$cat3)[1]),
           rep("#B8B8FF",table(g1$cat3)[2]),
           rep("#7F7FFF",table(g1$cat3)[3]))


coordinates(g2) <- ~lon+lat
g2@proj4string <- map.crs
g2 <- spTransform(g2, map.crs)
colo2 <- c(rep("#FFB8B8",table(g2$cat3)[4]),rep("#B871B8",table(g2$cat3)[5]))


coordinates(g3) <- ~lon+lat
g3@proj4string <- map.crs
g3 <- spTransform(g3, map.crs)
colo3 <- c("#FF7F7F")


coordinates(g2_big) <- ~lon+lat
g2_big@proj4string <- map.crs
g2_big <- spTransform(g2_big, map.crs)

coordinates(g3_big) <- ~lon+lat
g3_big@proj4string <- map.crs
g3_big <- spTransform(g3_big, map.crs)


#plot map and dots of different size based on category

plot(coast, xlim = c(-72,-68.1), ylim = c(40.5,45.5),col = "grey")
#plot(can, col = "grey", add = T)
plot(g1, pch = 16, col = colo1,cex = 1, add = T)
plot(g2, pch = 16, col = colo2,cex = 1, add = T)
plot(g3, pch = 16, col = colo3,cex = 1,add = T)


plot(g2_big, pch = 16, col = "blue",cex = 2, add = T)
plot(g3_big, pch = 16, col = c(rep("red",table(g3_big$cat3)[8]),rep("black",table(g3_big$cat3)[9])),cex = 2,add = T)

#colors of bivariate color scheme
base_col <- c("#7F7FFF","blue","black",
              "#B8B8FF","#B871B8","red",
              "#FFFFFF","#FFB8B8","#FF7F7F")

#raster image to display on plot as bivariate legend
r <- raster(xmn = -69.2, xmx = -67.7, ymn = 41, ymx = 42.1, nrows = 3, ncols = 3)
r[] <- 1:9
plot(r, col = base_col, legend = F, bty = "n", axes = F, yaxt = "n", frame.plot = F,
     xaxt='n', add = T)
axis(1, at = c(-72,-70,-68,-66), labels = paste( c(-72,-70,-68,-66) * -1, 'W'),pos = 40.29,col = NA, col.ticks = 1)
axis(2, at = axTicks(2), labels = paste(axTicks(2), 'N'), las = T, pos = -72.55,col = NA, col.ticks = 1)
box(lty = 1, lwd = 2)
#text
text(-69.475, 41.55, "Recreational Reliance",srt=90, cex = .75)
text(-68.4,40.8, "Social Vulnerability", cex = .75)
text(-72.25,45.5, "B", cex = 1.5)
}
```

##Climate Vulnerability of Coastal Fishing Communities
Assessment of the potential impacts of climate change on recreational and commercial fishermen and their communities has begun by linking social and economic indicators of community vulnerability and resilience to the climate vulnerability assessments of biological and ecological change expected to result from climate change New Bedford, the largest commercial fishing port in US (in terms of revenue) is heavily dependent on benthic species which are in turn highly vulnerable to climate change. Four of the top ports are dependent on an array of species, the majority of which are ranked as low to moderately vulnerable to climate change.

```{r 'species_vulnerability_NE' , fig.cap="Species vulnerability in Mid-Atlantic fishing communities \\label{sppvul}", echo = F, out.width = "450pt", fig.align='center', eval = T,fig.pos='H'}
knitr::include_graphics(file.path(image.dir, 'Species_vulnerability_NE.jpg'))
```


# Protected species-fishery interactions

Protected species include marine mammals (under the Marine Mammal Protection Act), Endangered and Threatened species (under the Endangered Species Act), and migratory birds (under the Migratory Bird Treaty Act). In the Northeast US, endangered/threatened species include Atlantic salmon, Atlantic and shortnose sturgeon, all sea turtle species, and 5 baleen whales. Fishery management objectives for protected species generally focus on reducing interactions between resource and protected species; here we report on the current status of these interactions as well as indicating the potential for future interactions driven by observed and predicted ecosystem changes in the Mid-Atlantic region. 

## Harbor porpoise
Harbor porpoise bycatch has resulted in fisheries closures in the past, but current bycatch levels demonstrate that management measures have been effective, reducing this fishery interaction. The 5-year mean bycatch has been below the maximum permitted level (Potential Biological Removal, PBR) since 2011 (Fig. \ref{harbporp}), and the most recent annual bycatch estimate is one of the lowest in the time series. Increased compliance and reduced fishing effort are thought to contribute to low bycatch estimates. There should be an updated harbor porpoise abundance estimate this year. Recent analyses have examined regional harbor porpoise diet, however, the impact of ecosystem changes on bycatch, population, or distribution remain unclear.

```{r harbor_porpoise, fig.cap="Harbor porpoise bycatch estimated compared with PBR \\label{harbporp}", echo = F, message=F, include=T, warning=F, fig.asp=0.5, fig.align = 'center',fig.pos='H'}
opar <- par(mar = c(4, 6, 2, 6))
#Harbor porpoise bycatch - Dropped mean line for clarity
soe.plot(SOE.data.2018, 'Time', "Harbor porpoise bycatch estimates",            
         rel.y.num = 1.2, end.start = 2007, full.trend = F, point.cex = 1,
         ymax = F, y.upper = 2500, mean_line = F, x.label = 'Year',
         y.label = 'Harbor Porpoise Bycatch, n', rel.y.text = 1)

legend(2000, 2250, legend = "Potential Biological Removal", col = adjustcolor("red", .5), lwd = 3,
       bty = "n")

#credible intervals and PBI
lw_CI <- SOE.data.2018[Var == 'Harbor porpoise bycatch 2.5 CI',  list(Time, Value)]
up_CI <- SOE.data.2018[Var == 'Harbor porpoise bycatch 97.5 CI', list(Time, Value)]
pbi   <- SOE.data.2018[Var == 'Harbor porpoise potential biological removal', list(Time, Value)]

points(pbi,   type  = "l", lty = 1, col = adjustcolor("red", .5), lwd = 3)
points(lw_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .9), lwd = 2.5)
points(up_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .9), lwd = 2.5)
```

## Sea Turtles
Sea turtles are known to be susceptible to climate and ecosystem changes, and their distribution is influenced by water temperature. Sea turtle diets contain a considerable amount of  gelatinous zooplankton, which are also influenced by changes in the pelagic ecosystem. At present, management measures to reduce sea turtle-fishery interactions are limited to the regions with historical observations of sea turtles and based on historical ocean temperature distributions. However, changes in climate may cause turtles to shift northward into areas with heavy fishing, possibly resulting in increased bycatch, and necessitating new management measures. 

## Right whale 
North Atlantic right whales are among the most endangered large whale populations in the world. Changes in right whale trends can have implications for fisheries management where fisheries interact with these whales. Additional management restrictions could have a large impact on fishing times, gears, etc.

Although the population increased steadily from 1990 to 2011, it has decreased recently. From Pace et al 2017: “The probability that the population’s trajectory post-2010 was a decline was estimated at 99.99%.” Reduced survival rates of adult females and diverging abundance trends between sexes have also been observed. Further, right whale distribution has changed since 2010. The reasons for these changes is unclear, but changes in climate and primary prey (Calanus finmarchicus) are suspected. Not yet reflected in this trend are the 17 right whale deaths observed in 2017, 5 due to vessel strike (1 in US waters, 4 in Canadian waters), 3 from entanglement (2 in Canadian gear, 1 in unknown gear), and the rest from unknown causes. 

```{r rw_abundance, fig.cap="Right whale population estimate\\label{rightwh}",echo = F, message=F, include=T, warning=F, fig.asp=0.5, fig.align = 'center',fig.pos='H'}
opar <- par(mar = c(4, 6, 2, 6))

soe.plot(SOE.data.2018, 'Time', "right_whale_median", rel.y.num = 1.2, 
         full.trend = F, lwd = 1.5, point.cex = 1, end.start = 2007,
         x.label = 'Year', y.label = 'Median Right Whale \nAbundance, n', 
         rel.y.text = 1)

lw_CI <- SOE.data.2018[Var == 'right_whale_lower_95', list(Time, Value)]
up_CI <- SOE.data.2018[Var == 'right_whale_upper_95', list(Time, Value)]
points(lw_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .6), lwd = 2.5)
points(up_CI, type  = "l", lty = 2, col = adjustcolor("darkorange", .6), lwd = 2.5)

```

#Resource Species

### Survey biomass (GOM)
```{r spring_fall_survey_biomass_GOM, fig.cap="Fall (left) and Spring (right) Gulf of Maine survey biomass (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)",  echo = F, fig.show='hold', fig.align='default',out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Fall Biomass Index GOM", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Planktivore Fall Biomass Index GOM", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthivore Fall Biomass Index GOM", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthos Fall Biomass Index GOM", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Spring Biomass Index GOM", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Planktivore Spring Biomass Index GOM", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthivore Spring Biomass Index GOM", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthos Spring Biomass Index GOM", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)

```

### Survey biomass (GB)
```{r spring_fall_survey_biomass_GB, fig.cap="Fall (left) and Spring (right) Georges Bank survey biomass (A: Piscivore, B: Planktivore, C: Benthivore, D: Benthos)",  echo = F, fig.show='hold', fig.align='default',out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Fall Biomass Index GB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Planktivore Fall Biomass Index GB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthivore Fall Biomass Index GB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthos Fall Biomass Index GB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1,end.start = 2007, cex.stacked = 2)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)

opar <- par(mfrow = c(4, 1), mar = c(0, 0, 0, 0), oma = c(4, 6.5, 2, 6))

soe.plot(SOE.data.2018, "Time", "Piscivore Spring Biomass Index GB", stacked = "A",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Planktivore Spring Biomass Index GB", stacked = "B",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthivore Spring Biomass Index GB", stacked = "C",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.plot(SOE.data.2018, "Time", "Benthos Spring Biomass Index GB", stacked = "D",status  = F,
         endshade = T, rel.y.num = 1.1, full.trend = T, scale.axis = 1, cex.stacked = 2)

soe.stacked.axis("Time",expression("Biomass, kg tow"^-1*''), outer = T)

```

## Species composition

Diversity in species composition mainly addresses objectives related to ecosystem structure and stability; maintaining diversity can provide the capacity to adapt to change at the ecosystem level and for dependent fishing communities. Diversity (here estimated using data from NOAA NEFSC Oceans and Climate branch public dataset for 45 abundant and well-identified ichthyoplankton taxa (Walsh et al. 2015))  shows a decrease for one season (spring), suggesting that survey timing may be interacting with changes in spawn timing or migration of adult fish (see above) as well as a potential change in ichthyoplankton availability due to adult fish distribution shifts (see below).  The decrease in spring ichthyoplankton diversity coincides with an increase in the spring abundance of sand lance (Ammodytes spp.) larvae, an important prey species (Richardson et al. 2014).  Walsh et al. (2015) documented a significant seasonal shift from winter to spring based on annual relative proportions from 1977-1987 to 1999-2008. 

```{r larval_diversity, fig.cap="Ichthyoplankton Shannon diversity and species counts in the Spring (Top row) and Fall (bottom row)",echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time","Spring_Ich_Shannon Diversity Index", stacked = "A",
         rel.y.num = 1.1, full.trend = F, end.start = 2006)
soe.plot(SOE.data.2018, "Time","Fall_Ich_Shannon Diversity Index", stacked = "B",
         rel.y.num = 1.1, full.trend = F, end.start = 2006)
soe.stacked.axis('Year', 'Shannon Index', rel.x.text = 1.2, rel.y.text = 1.2)

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))
soe.plot(SOE.data.2018, "Time","larval species count spring", stacked = "C",
         rel.y.num = 1.1, full.trend = F, suppressAxis = T, end.start = 2006)
soe.plot(SOE.data.2018, "Time","larval species count fall", stacked = "D",
         rel.y.num = 1.1, full.trend = F, end.start = 2006)
soe.stacked.axis('Year', 'Species Present, n', y.line = 2.5, rel.x.text = 1.2, rel.y.text = 1.2)

```

\newpage


```{r kdes_and_th_maps_MAB,fig.cap="Current and historical abundance estimates (A), current thermal habitat estimate (B), and 20-40 year thermal habitat projection (C) for sea scallop (top) and Atlantic cod (bottom). \\label{thermhab}" , fig.width = 8,fig.height = 5.5, fig.show='hold',fig.pos='H', warning=F, message=F}
#fill plot with images

kde1 <- readPNG(file.path(image.dir, "sea_scallop_kde.png"))
kde2 <- readPNG(file.path(image.dir,"atlantic_cod_kde.png"))
par(mar=c(2.5,2,2,2), xpd=NA, mgp=c(3,1,0), oma=c(0,1,0,0), ann=F, mfrow = c(2,3))
plot.new()
usr<-par("usr")

par(mfg=c(1,1))
rasterImage(kde1, usr[1], usr[3], usr[2], usr[4])
text(.12,.95, "A", cex=1.5)
par(mfg=c(2,1))
rasterImage(kde2, usr[1], usr[3], usr[2], usr[4])
text(.12,.95, "D", cex=1.5)
par(mfg=c(1,2))
th_plot(data = file.path(gis.dir, "Sea scallopfall_2.nc"),
        letter = "B", z.max = 2.855913, y.axis = T, legend = F, pos = "topleft")
par(mfg=c(1,3))
th_plot(data = file.path(gis.dir, "Sea scallopfall_4.nc"), 
        letter = "C", z.max =2.855913, y.axis = T, legend = T, pos = "topright")


par(mfg=c(2,2))
th_plot(data = file.path(gis.dir, "Atlantic codfall_2.nc"), 
        letter = "E", z.max = 5.190186, y.axis = T, legend = F, pos = "bottomleft")
par(mfg = c(2,3))
th_plot(data = file.path(gis.dir,"Atlantic codfall_4.nc"), 
        letter = "F", z.max = 5.190186, y.axis = T, legend = T, pos = "bottomright")


```

```{r sea_scallop_species_distributions_MAB, fig.cap="Sea scallop mean depth and along shelf distance trends (Top row: Spring, bottom row: Fall)",  echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "sea scallop spring mean depth", stacked = "A",
         rel.y.num = 1.1, x.start = 1963, end.start = 2007, cex.stacked = 1.5)
soe.plot(SOE.data.2018, "Time", "sea scallop fall mean depth", stacked = "B",
         rel.y.num = 1.1, line.forward = T, end.start = 2007, cex.stacked = 1.5)
soe.stacked.axis("Year", "Mean depth, m")

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "sea scallop spring mean along-shelf dist", 
         stacked = "C", rel.y.num = 1.1, suppressAxis = T, 
         line.forward = T, tol = 0.15, x.start = 1963, end.start = 2007, cex.stacked = 1.5)
soe.plot(SOE.data.2018, "Time", "sea scallop fall mean along-shelf dist", 
         stacked = "D", rel.y.num = 1.1, tol = 0.15, end.start = 2007, cex.stacked = 1.5)
soe.stacked.axis("Year", "Mean along-shelf distance, km", y.line = 3.0)

```




```{r atlantic cod_species_distributions_MAB, fig.cap="Atlantic cod mean depth and along-shelf distance trends (Top row: Spring, bottom row: Fall)",  echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "atlantic cod spring mean depth", stacked = "A",
         rel.y.num = 1.1, x.start = 1963, end.start = 2007, line.forward = T, cex.stacked = 1.5)
soe.plot(SOE.data.2018, "Time", "atlantic cod fall mean depth", stacked = "B",
         rel.y.num = 1.1, line.forward = T, end.start = 2007, cex.stacked = 1.5)
soe.stacked.axis("Year", "Mean depth, m")

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "atlantic cod spring mean along-shelf dist", 
         stacked = "C", rel.y.num = 1.1, suppressAxis = T, extra = F,
         line.forward = T, tol = 0.15, x.start = 1963, end.start = 2007, cex.stacked = 1.5)
soe.plot(SOE.data.2018, "Time", "atlantic cod fall mean along-shelf dist", 
         stacked = "D", rel.y.num = 1.1, tol = 0.15, end.start = 2007,
          line.forward = T, cex.stacked = 1.5)
soe.stacked.axis("Year", "Mean along-shelf distance, km", y.line = 3.0)

```

# Sea-surface temperatures

### Long-term SSTs
```{r long_term_sst,fig.cap="Long-term sea surface temperatures on the Northeast Continental Shelf",  echo=F, message=FALSE, warning=FALSE , fig.height=2.5, fig.align = 'center',fig.pos='H'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time", "long term SST jan-jun", end.start = 2007, 
         line.forward = TRUE, point.cex = 0.8, rel.y.text = 1.1,
         x.line = 2, y.line = 2.3, x.label = 'Year', rel.y.num = 1.1,
         y.label = expression(paste("Mean SST (",degree,"C)")))

```

```{r sst_anomaly_maps,fig.cap="Sea surface temperature anomalies in Fall (A), Winter (B), Spring (C), and Summer (D) 2017. \\label{dists}" , fig.width = 8,fig.height = 5.5, fig.show='hold',fig.pos='H'}
if (map_figs == T){


  
#constants
colors <- colorRampPalette(c("dodgerblue4",'blue', 'white', 'firebrick1',"firebrick4"))  
color_levels=100   

#SST map function
SST_plot <- function(raster_data, text,pos = "left"){
  
  #adjusts par for legend placement 
  if (pos == "right"){
    par(mar = c(4.5,0,3,10), mex = .3,  mgp = c(4, .35, 0))
  } else{
     par(mar = c(4.1,5,3,6), mex = .3,  mgp = c(4, .35, 0))
  }
  
  #read .nc and convert to raster
  d <- raster(raster_data, varname = "ANOM")
  crs(d) <- map.crs
  #crop data
  d <- crop(d, e)
  
  #get zmax
  z.max=max(d[][is.finite(d[])])

  #plot raster
  plot(d, col=colors(n=color_levels),
       breaks=seq(-z.max,z.max,length.out=color_levels+1),
       legend.width = 1.5,bty ="L",axes=F,
       interpolate = T, las = 1,box = FALSE,legend = FALSE, asp = 1)
  #plot contour
  contour(bathy,drawlabels = F,nlevels = 5,add=T)
  #plot coastline
  plot(coast, col = 'grey',add = T , lty=0)
  #axes

  
  if (pos == "left"){
    axis(1, at = seq(-77,-65,2), labels = seq(-77,-65,2) , cex.axis = 0.7)
    axis(2, cex.axis = 0.7)
    abline(h = 34.95, lty = 1, lwd = 2)
    abline(v =-77.2, lty = 1, lwd = 2)
  } else {
    axis(1, at = seq(-77,-65,2), labels = seq(-77,-65,2) ,
         cex.axis = 0.7, pos = 34.9)
    axis(2, cex.axis = 0.7, pos = -77.225)
    abline(h = 34.9, lty = 1, lwd = 2)
    abline(v =-77.225, lty = 1, lwd = 2)

  }

  #labels
  text(-76,45,text,cex = 1.5)

  
}

#plot maps
par(oma=c(0,0,0,0), mfrow = c(2,2))
SST_plot("2017_Fall_SST_anomaly.nc","A")
SST_plot("2017_Winter_SST_anomaly.nc","B",pos = "right")
SST_plot("2017_Spring_SST_anomaly.nc","C")
SST_plot("2017_Summer_SST_anomaly.nc","D",pos = "right") 

#plot only legend
colors <- colorRampPalette(c("dodgerblue4",'blue', 'white', 'firebrick1',"firebrick4")) 
color_levels=100 
z.max=7.21

#set new par
par(mfrow=c(1, 1), mar=c(2, 5, 2, 0), new=FALSE)

#any data
d <- raster(matrix(runif(100), ncol=10))

#legend plot
plot(d, col=colors(n=color_levels),
     breaks=seq(-z.max,z.max,length.out=color_levels+1),
     legend.shrink = 1,
     legend.width = 1,legend.only = T,
     axes=F, interpolate = T, las = 1,box = FALSE,
     axis.args=list(at=seq(-z.max, z.max, length.out = 5),
                    labels=seq(-4,4,length.out = 5), 
                    cex.axis=0.8),
     legend.args=list(text=expression(paste('Temperature Anomaly (',degree,"C)")),
                      side=4, font=2, line=2, cex=1))
}

```



# Ecosystem productivity

```{r SST_PPD_CHL_GOM, fig.cap="SST (A), primary production (B), and Chl a (C) over 2017 (colored polygons) compared against long-term mean (black line) and +/- 1 standard deviation (grey polygon) in Gulf of Maine", echo = F, out.width=c('6.5cm','6.5cm','6.5cm'), out.height=c('7cm','7cm','7cm'), fig.show='hold',fig.ncol = 3,fig.pos='H'}

## SST
opar <- par(mar = c(4, 5, 2, 5))
doy <- as.numeric(SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 GOM",]$Time)
val_2017 <- SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 GOM",]$Value
val_LT <- SOE.data.2018[SOE.data.2018$Var == "sst mean long term GOM",]$Value
val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sst sd long term GOM",]$Value


val_2017 <- approx(doy,val_2017, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT <- approx(doy,val_LT, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT_sd <- approx(doy,val_LT_sd, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
doy <- seq(doy[1],doy[length(doy)],length.out = 365*1)


above_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT[i]){
    above_mean[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i]){
    below_mean[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT_sd[i] + val_LT[i]){
    above_sd[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT_sd [i] + val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i] - val_LT_sd[i]){
    below_sd[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT[i] - val_LT_sd [i]){
    below_sd[i] <- NA
  }
}

#Lines for polygons
above_sd[is.na(above_sd)] <- val_LT_sd[which(is.na(above_sd))] + val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- val_LT[which(is.na(below_sd))] - val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- val_LT[which(is.na(below_mean))]

upper <- val_LT_sd + val_LT
lower <- val_LT - val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]), ylim = c(2,26.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,61,122,183,245,306,365), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Mean SST (",degree,"C)")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(15,26.5*.95,"A",cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-val_LT), rev(above_mean)),
        col = "orange", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(val_LT + val_LT_sd)), rev(above_sd)),
        col = "red", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(val_LT - val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,val_LT, type = "l", lwd = 1, "grey90")
#points(doy,val_2017, type = "l", lwd = .5, "black")



## primary production
doy <- seq(1,52,1)
ppd_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd 2017 GOM",]$Value
ppd_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd long term GOM",]$Value
ppd_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd ppd long term GOM",]$Value

above_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT[i]){
    above_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i]){
    below_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT_sd[i] + ppd_val_LT[i]){
    above_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT_sd [i] + ppd_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i] - ppd_val_LT_sd[i]){
    below_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT[i] - ppd_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- ppd_val_LT_sd[which(is.na(above_sd))] + ppd_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- ppd_val_LT[which(is.na(below_sd))] - ppd_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- ppd_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- ppd_val_LT[which(is.na(below_mean))]

upper <- ppd_val_LT_sd + ppd_val_LT
lower <- ppd_val_LT - ppd_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Primary Production (gC m"^-2*"d"^-1*")")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(2,2*.95,"B", cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (ppd_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-ppd_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(ppd_val_LT + ppd_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(ppd_val_LT - ppd_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,ppd_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,ppd_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)

## Chlorophyll a
chl_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl 2017 GOM",]$Value
chl_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl long term GOM",]$Value
chl_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd chl long term GOM",]$Value

above_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT[i]){
    above_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i]){
    below_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT_sd[i] + chl_val_LT[i]){
    above_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT_sd [i] + chl_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i] - chl_val_LT_sd[i]){
    below_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT[i] - chl_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- chl_val_LT_sd[which(is.na(above_sd))] + chl_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- chl_val_LT[which(is.na(below_sd))] - chl_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- chl_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- chl_val_LT[which(is.na(below_mean))]

upper <- chl_val_LT_sd + chl_val_LT
lower <- chl_val_LT - chl_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Chl ",alpha," mg m"^-3*"")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)

# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (chl_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-chl_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(chl_val_LT + chl_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(chl_val_LT - chl_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,chl_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,chl_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)
text(2,2.5*.95,"C", cex = 1.5)
```

```{r SST_PPD_CHL_GB, fig.cap="SST (A), primary production (B), and Chl a (C) over 2017 (colored polygons) compared against long-term mean (black line) and +/- 1 standard deviation (grey polygon) in Georges Bank", echo = F, out.width=c('6.5cm','6.5cm','6.5cm'), out.height=c('7cm','7cm','7cm'), fig.show='hold',fig.ncol = 3,fig.pos='H'}

## SST
opar <- par(mar = c(4, 5, 2, 5))
doy <- as.numeric(SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 GB",]$Time)
val_2017 <- SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 GB",]$Value
val_LT <- SOE.data.2018[SOE.data.2018$Var == "sst mean long term GB",]$Value
val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sst sd long term GBK",]$Value


val_2017 <- approx(doy,val_2017, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT <- approx(doy,val_LT, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
val_LT_sd <- approx(doy,val_LT_sd, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
doy <- seq(doy[1],doy[length(doy)],length.out = 365*1)


above_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT[i]){
    above_mean[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i]){
    below_mean[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT_sd[i] + val_LT[i]){
    above_sd[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT_sd [i] + val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i] - val_LT_sd[i]){
    below_sd[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT[i] - val_LT_sd [i]){
    below_sd[i] <- NA
  }
}

#Lines for polygons
above_sd[is.na(above_sd)] <- val_LT_sd[which(is.na(above_sd))] + val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- val_LT[which(is.na(below_sd))] - val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- val_LT[which(is.na(below_mean))]

upper <- val_LT_sd + val_LT
lower <- val_LT - val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]), ylim = c(2,26.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,61,122,183,245,306,365), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Mean SST (",degree,"C)")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(15,26.5*.95,"A",cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-val_LT), rev(above_mean)),
        col = "orange", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(val_LT + val_LT_sd)), rev(above_sd)),
        col = "red", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(val_LT - val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,val_LT, type = "l", lwd = 1, "grey90")
#points(doy,val_2017, type = "l", lwd = .5, "black")



## primary production
doy <- seq(1,52,1)
ppd_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd 2017 GB",]$Value
ppd_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd long term GB",]$Value
ppd_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd ppd long term GB",]$Value

above_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT[i]){
    above_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i]){
    below_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT_sd[i] + ppd_val_LT[i]){
    above_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT_sd [i] + ppd_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i] - ppd_val_LT_sd[i]){
    below_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT[i] - ppd_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- ppd_val_LT_sd[which(is.na(above_sd))] + ppd_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- ppd_val_LT[which(is.na(below_sd))] - ppd_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- ppd_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- ppd_val_LT[which(is.na(below_mean))]

upper <- ppd_val_LT_sd + ppd_val_LT
lower <- ppd_val_LT - ppd_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Primary Production (gC m"^-2*"d"^-1*")")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)
text(2,2*.95,"B", cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (ppd_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-ppd_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(ppd_val_LT + ppd_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(ppd_val_LT - ppd_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,ppd_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,ppd_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)

## Chlorophyll a
chl_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl 2017 GB",]$Value
chl_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl long term GB",]$Value
chl_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd chl long term GB",]$Value

above_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT[i]){
    above_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i]){
    below_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT_sd[i] + chl_val_LT[i]){
    above_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT_sd [i] + chl_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i] - chl_val_LT_sd[i]){
    below_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT[i] - chl_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- chl_val_LT_sd[which(is.na(above_sd))] + chl_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- chl_val_LT[which(is.na(below_sd))] - chl_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- chl_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- chl_val_LT[which(is.na(below_mean))]

upper <- chl_val_LT_sd + chl_val_LT
lower <- chl_val_LT - chl_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2.5), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Chl ",alpha," mg m"^-3*"")), cex = 1.5)
mtext(1, line = 2.5, text = "Time", cex = 1.5)

# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey95", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (chl_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-chl_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(chl_val_LT + chl_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(chl_val_LT - chl_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,chl_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,chl_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)
text(2,2.5*.95,"C", cex = 1.5)
```


```{r chl_ppd_maps,fig.cap="Primary production (left) and chlorophyll (right) anomalies along the Northeast Shelf\\label{ppchlanom}" ,  fig.width = 8,fig.height = 4, fig.show='hold',fig.pos='H'}
#read images
#read images
ppd <-readPNG(file.path(image.dir,'PPD_anom_NES.png'))
chl <-readPNG(file.path(image.dir,'CHL_anom_NES.png'))
par(mar=c(0,0,0,0), xpd=NA, mgp=c(0,0,0), oma=c(0,0,0,0), ann=F, mfrow = c(1,2))
plot.new()
usr<-par("usr")

#fill plot with images
rasterImage(ppd, usr[1], usr[3], usr[2], usr[4])
rasterImage(chl, usr[1]+1.1, usr[3], usr[2]+1.1, usr[4])
```

```{r, NE zooplankton, fig.cap="Small-large copepod index with primary productivity anomaly in Gulf of Maine (A) and Georges Bank (B).",echo = F, warning = F, include = T,  fig.show='hold', fig.align='default', warning = F, message = F, fig.height = 6.2, fig.width=5}

par(mfrow = c(2,1), mar = c(5,4,1,4))
###### Gulf of Maine #####

#small-large copepod index
GOM_prim_prod <- finder(SOE.data.2018, "annual ppd ratio anomaly GOM")
GOM_copepod_anom <- finder(SOE.data.2018, "Small-Large copepod Index GOM")

plot(NULL,ylim = c(-1.5,1.5), pch = 16, lwd = 3,xlim = c(1998,2017),
       cex = 1, ylab = "", las = 1, xaxt = "n", cex.axis = 1.2, xlab = "")
abline(h = 0, col  = "grey", lwd = 3, lty = 2) 
with(SOE.data.2018[SOE.data.2018$Var == GOM_copepod_anom,], points(Time[22:39], Value[22:39],
       type = "o", col = "black", ylim = c(-1.5,1.5), pch = 16, lwd = 3,las = 1))
mtext(side = 2, line = 3, "Small-Lg Copepod Index", cex = 1)
text(1998,1.4,"A",cex = 1.2)
par(new = T)

#primary productivity
with(SOE.data.2018[SOE.data.2018$Var ==  GOM_prim_prod[1],], plot(Time, Value,
       type = "o", col =  "springgreen2", ylim = c(.8,1.25), ylab = "", axes = F,log = "y",
       yaxt = "n", pch = 16, lwd = 3, cex = 1, las = 1, xaxt = "n",xlab = ""))
axis(side = 4, las = 1, cex.axis = 1.2)
axis(side = 1, cex.axis = 1.2)
mtext(side = 4, line = 3, "Primary Production Ratio", cex = 1)
mtext(side = 1, "", cex = 1.2, text = "Year",line = 2.5)
legend("bottomright",
         legend = c("Copepod Index", "Prim. Prod. Ratio"), col = c("black","springgreen2"),
         bty = "n", lwd = 3)

######### Georges Bank ######

#small-large copepod index
GB_prim_prod <- finder(SOE.data.2018, "annual ppd ratio anomaly GB")
GB_copepod_anom <- finder(SOE.data.2018, "Small-Large copepod Index GB")

plot(NULL,ylim = c(-1.5,1.5), pch = 16, lwd = 3,xlim = c(1998,2017),
       cex = 1.2, ylab = "", las = 1, xaxt = "n", cex.axis = 1.2, xlab = "")
abline(h = 0, col  = "grey", lwd = 3, lty = 2) 
with(SOE.data.2018[SOE.data.2018$Var == GB_copepod_anom,], points(Time[22:39], Value[22:39],
       type = "o", col = "black", ylim = c(-1.5,1.5), pch = 16, lwd = 3,las = 1))
mtext(side = 2, line = 3, "Small-Lg Copepod Index", cex = 1)
text(1998,1.4,"B",cex = 1.2)
par(new = T)

#primary productivity
with(SOE.data.2018[SOE.data.2018$Var ==  GB_prim_prod[1],], plot(Time, Value,
       type = "o", col =  "springgreen2", ylim = c(.8,1.25), ylab = "", axes = F,log = "y",
       yaxt = "n", pch = 16, lwd = 3, cex = 1.2, las = 1, xaxt = "n",xlab = ""))
axis(side = 4, las = 1, cex.axis = 1.2)
axis(side = 1, cex.axis = 1.2)
mtext(side = 4, line = 3, "Primary Production Ratio", cex = 1)
mtext(side = 1, "", cex = 1.2, text = "Year",line = 2.5)
legend("bottomright",
         legend = c("Copepod Index", "Prim. Prod. Ratio"), col = c("black","springgreen2"),
         bty = "n", lwd = 3)
```


```{r, GOM_GB zooplankton, fig.cap="\\textit{Pseudocalanus spp.} (top row) and \\textit{C. finmarchicus} (bottom row) abundance anomalies in Gulf of Maine (left) and Georges Bank (right)",  echo = F, fig.show='hold', fig.align='default', out.width='.49\\linewidth',warning = F, message = F,fig.pos='H'}
opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))


soe.plot(SOE.data.2018, "Time", "Pseudocalanus spp. abundance anomaly GOM", stacked = "A",
         rel.y.num = 1.1,line.forward = T, cex.stacked = 1.5,end.start = 2006,
         anomaly = T)
soe.plot(SOE.data.2018, "Time", "Calanus finmarchicus abundance anomaly GOM", stacked = "B",
         rel.y.num = 1.1, line.forward = T,cex.stacked = 1.5,end.start = 2006,
         anomaly = T)
soe.stacked.axis("Year", "Abundance anomaly")

opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(3.5, 5, 2, 4))

soe.plot(SOE.data.2018, "Time", "Pseudocalanus spp. abundance anomaly GB", stacked = "C",
         rel.y.num = 1.1,line.forward = T, cex.stacked = 1.5,end.start = 2006,
         anomaly = T, suppressAxis = T)
soe.plot(SOE.data.2018, "Time", "Calanus finmarchicus abundance anomaly GB", stacked = "D",
         rel.y.num = 1.1, line.forward = T,cex.stacked = 1.5,end.start = 2006,
         anomaly = T)
soe.stacked.axis("Year", "Abundance anomaly")

```

```{r 'condition factor NE' , fig.cap="Groundfish condition, MAB", echo = F, out.height='10cm', fig.align='center',fig.pos='H'}
knitr::include_graphics(file.path(image.dir, 'NEFMC_Fish_Condition_2018.jpg'))
```

### Groundfish productivity

The number of small fish relative to the biomass of larger fish of the same species from the NEFSC survey is a simple measure of productivity, intended to complement model-based stock assessment estimates of recruitment for commercial species. 

```{r groundfish productivity, fig.cap="Groundfish productivity (A: MAFMC managed species, B: Commercial MAB Species)", echo = F, out.width='9.2cm', out.height='9.2cm', fig.show='hold', fig.align = 'center',fig.pos='H'}
## Functions for plotting
library(ggplot2)
library(rpart)

#### Adjust plot properties -------------------------------
adjustAxes <- 
  ggplot2::theme(axis.title   = element_text(size = 18),
                 axis.text    = element_text(size = 15),
                 plot.title   = element_text(size = 20))

ggplot <- function(...) { ggplot2::ggplot(...)  + 
    ggplot2::theme_bw() + 
    adjustAxes}


#### Plot stacked bar with cpts for single var ------------
plot_stackbarcpts_single <- function(YEAR, var2bar,
                                     x, xlab, ylab,
                                     titl,
                                     file_suffix,
                                     leg_font_size = 10,
                                     remove_leg = FALSE,
                                     leg_ncol = 1,
                                     wcpts = TRUE,
                                     wdashed = TRUE,
                                     height = 5.5,
                                     width = 8,
                                     filt = TRUE,
                                     label = label,
                                     y.text = y.text) {
  
  dat2bar <- data.frame(YEAR, var2bar,
                        x)
  if (filt == TRUE){ne_species <-   list("ATLANTIC COD", "HADDOCK", "AMERICAN PLAICE","WITCH FLOUNDER", "WINTER FLOUNDER", "YELLOWTAIL FLOUNDER","ACADIAN REDFISH","POLLOCK","WHITE HAKE", "ATLANTIC HALIBUT", "OCEAN POUT","WINDOWPANE FLOUNDER", "WOLFFISH","SILVER HAKE", "RED HAKE", "OFFSHORE HAKE", "SEA SCALLOP","GOOSEFISH", "ATLANTIC HERRING", "WINTER SKATE","SMOOTH SKATE", "THORNY SKATE", "BARNDOOR SKATE","LITTLE SKATE","CLEARNOSE SKATE","ROSETTE SKATE","CRAB,RED DEEPSEA", "SPINY DOGFISH", "ATLANTIC SALMON", "ATLANTIC HALIBUT")
  dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar)) %>%
    filter(var2bar %in% ne_species)
} else if (filt == FALSE){
    dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar))
}
  p <-   
    ggplot(dat2plot,
           aes(x = YEAR)) +
    geom_bar(data = dat2plot %>% filter(value > 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_bar(data = dat2plot %>% filter(value < 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_hline(size = 0.3, aes(yintercept = 0)) +
    xlab(xlab) +
    ylab(ylab) +
    ggtitle(titl) +
    guides(fill = guide_legend(ncol = leg_ncol)) +
    theme(axis.title   = element_text(size = 16),
          axis.text    = element_text(size = 15),
          plot.title   = element_text(size = 20),
          legend.text  = element_text(size = leg_font_size),
          legend.title = element_blank()) +
    annotate("text", label = label, x = 1980, y = y.text,size = 8, colour = "black")
  
  if(remove_leg) p <- p + theme(legend.position = "none")
  
  print(p)
  
  #ggsave(plot = p,
  #       filename = "./productivity_all.eps",
  #       width = width,
  #       height = height)
}

bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "GOM",]
plot_stackbarcpts_single(YEAR = bar_dat$Time,
                         var2bar = bar_dat$Var,
                         x = bar_dat$Value,
                         titl = "",
                         xlab = "",
                         ylab = "Small fish per large fish biomass (anomaly)",
                         height = 5.5,
                         width = 9,
                         filt = TRUE,
                         label = "A",
                         y.text = 10)

bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "GOM",]
plot_stackbarcpts_single(YEAR = bar_dat$Time,
                         var2bar = bar_dat$Var,
                         x = bar_dat$Value,
                         titl = "",
                         xlab = "",
                         ylab = "Small fish per large fish biomass (anomaly)",
                         height = 5.5,
                         width = 9,
                         filt = FALSE,
                         label = "B",
                         y.text = 10)
```